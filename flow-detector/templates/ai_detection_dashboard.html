<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI白流量检测系统 - 真实数据检测平台</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- jsPDF for PDF generation with Chinese font support -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for better content rendering -->
    <script src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- 自定义样式 -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --background-color: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --text-color: #333;
            --card-bg: #ffffff;
            --navbar-bg: #ffffff;
            --border-color: #dee2e6;
        }
        
        [data-theme="dark"] {
            --primary-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --background-color: #1a1a1a;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --text-color: #ffffff;
            --card-bg: #2d3748;
            --navbar-bg: #2d3748;
            --border-color: #4a5568;
        }
        
        body {
            background-color: var(--background-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: var(--primary-color) !important;
        }
        
        .navbar {
            background-color: var(--navbar-bg) !important;
            transition: background-color 0.3s ease;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 8px 12px;
            border-radius: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .theme-toggle:hover {
            background-color: var(--info-color);
            color: white;
            transform: scale(1.1);
        }
        
        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .upload-zone {
            border: 3px dashed var(--border-color);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--card-bg);
            position: relative;
            overflow: hidden;
        }
        
        /* 流量动画背景 */
        .traffic-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.1;
        }
        
        .data-packet {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--info-color);
            border-radius: 50%;
            animation: packetFlow 3s linear infinite;
        }
        
        @keyframes packetFlow {
            0% {
                transform: translateX(-10px) translateY(0px);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(calc(100vw + 10px)) translateY(0px);
                opacity: 0;
            }
        }
        
        /* 网络拓扑装饰 */
        .network-topology {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 60px;
            height: 60px;
            opacity: 0.2;
        }
        
        .network-node {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .network-line {
            position: absolute;
            height: 1px;
            background: var(--info-color);
            transform-origin: left center;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.3);
                opacity: 1;
            }
        }
        
        /* 数据流动效果 */
        .data-flow {
            position: relative;
            overflow: hidden;
        }
        
        .data-flow::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.3), transparent);
            animation: dataFlow 2s ease-in-out infinite;
        }
        
        @keyframes dataFlow {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        /* 实时流量监控图标 */
        .traffic-monitor {
            display: inline-block;
            position: relative;
        }
        
        .traffic-monitor::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: blink 1s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 50% {
                opacity: 1;
            }
            51%, 100% {
                opacity: 0;
            }
        }
            cursor: pointer;
        }
        
        .upload-zone:hover {
            border-color: var(--info-color);
            background: rgba(52, 152, 219, 0.05);
        }
        
        .upload-zone.dragover {
            border-color: var(--success-color);
            background: rgba(39, 174, 96, 0.1);
        }
        
        .analysis-card {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            padding: 25px;
            margin-bottom: 25px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .progress-wrapper {
            position: relative;
            margin: 20px 0;
        }
        
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            z-index: 2;
        }
        
        .progress {
            height: 40px;
            border-radius: 20px;
            background: #e9ecef;
            overflow: visible;
        }
        
        .progress-bar {
            border-radius: 20px;
            transition: width 0.6s ease;
        }
        
        .metric-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .metric-card:hover {
            transform: scale(1.05);
        }
        
        .metric-card-small {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: var(--card-shadow);
            margin-bottom: 15px;
            transition: transform 0.2s ease;
        }
        
        .metric-card-small:hover {
            transform: scale(1.02);
        }
        
        .metric-card-small .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .metric-card-small .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .btn-custom {
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .results-container {
            display: none;
        }
        
        .alert-custom {
            border-radius: 10px;
            border: none;
            box-shadow: var(--card-shadow);
        }
        
        .spinner-border-custom {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .table-responsive {
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }
        
        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: bold;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
        }
        
        .security-status {
            border-radius: 50px;
            padding: 5px 15px;
            color: white;
            font-weight: bold;
            text-align: center;
            display: inline-block;
            min-width: 100px;
        }
        
        .status-safe { background: var(--success-color); }
        .status-warning { background: var(--warning-color); }
        .status-danger { background: var(--danger-color); }
        
        /* 准确率指标样式 */
        .accuracy-metric {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .accuracy-circle {
            position: relative;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .accuracy-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .accuracy-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .detail-metric {
            text-align: center;
            padding: 15px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .detail-value {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .detail-label {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        #accuracySection .analysis-card {
            border: 2px solid rgba(52, 152, 219, 0.3);
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.05), rgba(46, 204, 113, 0.05));
        }
        
        .file-info {
            background: var(--background-color);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        /* 增强流量分类样式 */
        .classification-group {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .classification-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .classification-metric {
            text-align: center;
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            margin: 5px 0;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .classification-metric:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .classification-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .classification-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .classification-group h6 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        /* 威胁导出按钮样式 */
        #exportThreatsBtn {
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        #exportThreatsBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
            background: linear-gradient(45deg, #c82333, #a71e2a);
        }

        #exportStatus {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* 暗色主题下的分类样式 */
        [data-theme="dark"] .classification-group {
            background: rgba(45, 55, 72, 0.8);
            border-color: #4a5568;
        }

        [data-theme="dark"] .classification-metric {
            background: rgba(26, 32, 44, 0.8);
            border-color: #4a5568;
        }

        /* 批量清空功能样式 */
        .clear-info-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .clear-info-panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .form-check-label {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid transparent;
        }

        .form-check-label:hover {
            background: rgba(var(--primary-color-rgb), 0.1);
            border-color: var(--primary-color);
        }

        .form-check-input:checked + .form-check-label {
            background: rgba(var(--primary-color-rgb), 0.15);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .progress-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }

        .clear-results {
            margin-top: 20px;
        }

        .clear-results .alert {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }

        #batchClearBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #batchClearBtn:not(:disabled):hover {
            background: linear-gradient(45deg, #c82333, #a71e2a);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
        }

        /* 暗色主题下的批量清空样式 */
        [data-theme="dark"] .clear-info-panel {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border-left-color: var(--primary-color);
        }

        [data-theme="dark"] .form-check-label:hover {
            background: rgba(66, 153, 225, 0.2);
            border-color: #4299e1;
        }

        [data-theme="dark"] .form-check-input:checked + .form-check-label {
            background: rgba(66, 153, 225, 0.25);
            border-color: #4299e1;
            color: #4299e1;
        }

        [data-theme="dark"] .progress-container {
            background: #2d3748;
            border-color: #4a5568;
        }
        
        @media (max-width: 768px) {
            .metric-card {
                margin-bottom: 15px;
            }
            
            .analysis-card {
                padding: 15px;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>

    <!-- 欢迎界面 Banner -->
    <div id="welcomeBanner" class="alert alert-primary shadow-sm rounded-3 px-4 py-3 mb-4 d-flex align-items-center justify-content-between fade show" style="background: linear-gradient(90deg, #e3f2fd 0%, #fff 100%); border-left: 6px solid #1976d2;">
        <div class="d-flex align-items-center">
            <i class="fas fa-hand-sparkles fa-2x text-primary me-3"></i>
            <div>
                <h4 class="mb-1 fw-bold">欢迎使用 AI白流量过滤系统</h4>
                <div class="text-muted">高效、智能的网络流量安全分析与管理平台</div>
            </div>
        </div>
        <button type="button" class="btn-close ms-3" aria-label="关闭" onclick="document.getElementById('welcomeBanner').style.display='none';"></button>
    </div>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <span class="traffic-monitor">
                    <i class="fas fa-shield-alt me-2"></i>
                </span>
                AI白流量过滤系统
                <small class="text-muted ms-2">实时网络安全分析</small>
            </a>
            
            <!-- 实时状态指示器 -->
            <div class="d-none d-md-flex align-items-center me-auto ms-4">
                <div class="d-flex align-items-center me-3">
                    <div class="network-topology me-2">
                        <div class="network-node" style="top: 5px; left: 5px;"></div>
                        <div class="network-node" style="top: 15px; left: 25px; animation-delay: 0.5s;"></div>
                        <div class="network-node" style="top: 35px; left: 15px; animation-delay: 1s;"></div>
                        <div class="network-line" style="top: 10px; left: 10px; width: 20px; transform: rotate(45deg);"></div>
                        <div class="network-line" style="top: 25px; left: 15px; width: 15px; transform: rotate(-30deg);"></div>
                    </div>
                    <span class="badge bg-success data-flow">在线监控</span>
                </div>
                <div class="d-flex align-items-center">
                    <i class="fas fa-server text-info me-1"></i>
                    <span class="small text-muted">系统就绪</span>
                </div>
            </div>
            
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-info me-2" onclick="showHistoryModal()" title="查看历史记录">
                    <i class="fas fa-history me-1"></i>历史记录
                </button>
                <button class="theme-toggle me-3" onclick="toggleTheme()" title="切换主题">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <span class="nav-link">
                    <i class="fas fa-clock me-1"></i>
                    <span id="currentTime"></span>
                </span>
            </div>
        </div>
    </nav>

    <!-- 主容器 -->
    <div class="container-fluid py-4">
        <!-- 系统状态卡片 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="status-card p-4" style="position: relative; overflow: hidden;">
                    <!-- 背景装饰 -->
                    <div style="position: absolute; top: -20px; right: -20px; opacity: 0.1;">
                        <i class="fas fa-network-wired" style="font-size: 6rem;"></i>
                    </div>
                    
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3>
                                <span class="traffic-monitor">
                                    <i class="fas fa-robot me-2"></i>
                                </span>
                                AI白流量过滤系统
                                <span class="badge bg-light text-dark ms-2">v2.0</span>
                            </h3>
                            <p class="mb-2">
                                <i class="fas fa-shield-check me-2"></i>
                                系统正常运行，准备接收流量数据进行智能分析
                            </p>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-success data-flow">
                                    <i class="fas fa-check-circle me-1"></i>AI引擎就绪
                                </span>
                                <span class="badge bg-info">
                                    <i class="fas fa-brain me-1"></i>LSTM模型已加载
                                </span>
                                <span class="badge bg-warning">
                                    <i class="fas fa-chart-line me-1"></i>实时监控
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="status-indicator">
                                <div class="network-topology mb-2"></div>
                                <div class="spinner-grow text-light" role="status" style="width: 1rem; height: 1rem;">
                                    <span class="visually-hidden">运行中...</span>
                                </div>
                                <span class="ms-2">系统在线</span>
                                <div class="small text-light-emphasis mt-1">
                                    <i class="fas fa-server me-1"></i>准备处理流量
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文件上传区域 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="analysis-card">
                    <h4><i class="fas fa-upload me-2"></i>数据上传与检测</h4>
                    <p class="text-muted">支持上传 PCAP、PCAPNG 或 CSV 格式的网络流量数据文件</p>
                    
                    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                        <!-- 流量动画背景 -->
                        <div class="traffic-animation"></div>
                        
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3" style="position: relative; z-index: 1;"></i>
                            <h5 style="position: relative; z-index: 1;">
                                <i class="fas fa-network-wired me-2"></i>
                                点击或拖拽流量文件到此区域
                            </h5>
                            <p class="text-muted" style="position: relative; z-index: 1;">
                                <i class="fas fa-file-code me-1"></i>
                                支持 .pcap, .pcapng, .csv 格式文件
                                <br>
                                <small class="text-info">
                                    <i class="fas fa-shield-check me-1"></i>
                                    实时AI分析 • 智能威胁检测 • 流量分类
                                </small>
                            </p>
                            <input type="file" id="fileInput" class="d-none" accept=".pcap,.pcapng,.csv">
                        </div>
                    </div>
                    
                    <div class="file-info d-none" id="fileInfo">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <i class="fas fa-file-alt me-2"></i>
                                <span id="fileName"></span>
                                <span class="badge bg-info ms-2" id="fileSize"></span>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-success btn-custom me-2" onclick="startAnalysis()">
                                    <i class="fas fa-play me-2"></i>开始分析
                                </button>
                                <button class="btn btn-secondary btn-custom" onclick="clearFile()">
                                    <i class="fas fa-times me-2"></i>清除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 处理进度 -->
        <div class="row mb-4 d-none" id="progressSection">
            <div class="col-md-12">
                <div class="analysis-card">
                    <h4><i class="fas fa-cogs me-2"></i>AI分析进度</h4>
                    <div class="progress-wrapper">
                        <div class="progress">
                            <div class="progress-bar bg-info" role="progressbar" id="analysisProgress"></div>
                        </div>
                        <div class="progress-text" id="progressText">准备中...</div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div id="stage1" class="stage-indicator">
                                    <i class="fas fa-database fa-2x"></i>
                                    <p class="mt-2 mb-0">数据加载</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div id="stage2" class="stage-indicator">
                                    <i class="fas fa-cogs fa-2x"></i>
                                    <p class="mt-2 mb-0">预处理</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div id="stage3" class="stage-indicator">
                                    <i class="fas fa-brain fa-2x"></i>
                                    <p class="mt-2 mb-0">AI分析</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div id="stage4" class="stage-indicator">
                                    <i class="fas fa-chart-line fa-2x"></i>
                                    <p class="mt-2 mb-0">生成报告</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 批量清空功能区域 -->
        <div class="row mb-4" id="batchClearSection">
            <div class="col-md-12">
                <div class="analysis-card">
                    <h4><i class="fas fa-broom me-2"></i>系统清理与维护</h4>
                    <p class="text-muted">批量清空系统数据，释放存储空间和内存资源</p>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="clearHistory" value="history">
                                        <label class="form-check-label" for="clearHistory">
                                            <i class="fas fa-history me-2 text-warning"></i>
                                            <strong>历史记录</strong>
                                            <br><small class="text-muted">清空分析历史数据库</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="clearUploads" value="uploads">
                                        <label class="form-check-label" for="clearUploads">
                                            <i class="fas fa-upload me-2 text-info"></i>
                                            <strong>上传文件</strong>
                                            <br><small class="text-muted">删除所有上传的文件</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="clearProcessed" value="processed">
                                        <label class="form-check-label" for="clearProcessed">
                                            <i class="fas fa-cogs me-2 text-success"></i>
                                            <strong>处理结果</strong>
                                            <br><small class="text-muted">清空分析结果文件</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="clearTemp" value="temp">
                                        <label class="form-check-label" for="clearTemp">
                                            <i class="fas fa-trash me-2 text-secondary"></i>
                                            <strong>临时文件</strong>
                                            <br><small class="text-muted">删除临时和缓存文件</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="clearMemory" value="memory">
                                        <label class="form-check-label" for="clearMemory">
                                            <i class="fas fa-memory me-2 text-danger"></i>
                                            <strong>内存清理</strong>
                                            <br><small class="text-muted">强制垃圾回收释放内存</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                        <label class="form-check-label" for="selectAll">
                                            <i class="fas fa-check-double me-2 text-primary"></i>
                                            <strong>全选/全不选</strong>
                                            <br><small class="text-muted">快速选择所有选项</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="clear-info-panel p-3" style="background: #f8f9fa; border-radius: 10px; border-left: 4px solid var(--primary-color);">
                                <h6><i class="fas fa-info-circle me-2"></i>清理信息</h6>
                                <div id="clearSizeInfo">
                                    <p class="mb-1"><small><i class="fas fa-database me-1"></i>历史记录: <span id="historyCount">加载中...</span></small></p>
                                    <p class="mb-1"><small><i class="fas fa-folder me-1"></i>上传文件: <span id="uploadCount">加载中...</span></small></p>
                                    <p class="mb-1"><small><i class="fas fa-file me-1"></i>处理结果: <span id="processedCount">加载中...</span></small></p>
                                    <p class="mb-0"><small><i class="fas fa-memory me-1"></i>内存使用: <span id="memoryUsage">加载中...</span></small></p>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshClearInfo()">
                                        <i class="fas fa-sync-alt me-1"></i>刷新
                                    </button>
                                    <button class="btn btn-danger" onclick="confirmBatchClear()" id="batchClearBtn" disabled>
                                        <i class="fas fa-broom me-2"></i>开始清理
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 清理进度 -->
                    <div class="progress-container d-none" id="clearProgressContainer">
                        <h6><i class="fas fa-spinner fa-spin me-2"></i>正在清理...</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-animated" id="clearProgressBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="clearProgressText">准备开始...</small>
                    </div>

                    <!-- 清理结果 -->
                    <div class="clear-results d-none" id="clearResults">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-2"></i>清理完成</h6>
                            <div id="clearResultDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分析结果 -->
        <div class="results-container" id="resultsContainer">
            <!-- 核心指标卡片 -->
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="metric-card data-flow">
                        <div class="traffic-monitor">
                            <i class="fas fa-stream fa-2x text-info"></i>
                        </div>
                        <div class="metric-value text-info" id="totalFlows">-</div>
                        <div class="metric-label">
                            <i class="fas fa-network-wired me-1"></i>总流量数
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="metric-card">
                        <i class="fas fa-stopwatch fa-2x text-success"></i>
                        <div class="metric-value text-success" id="processingTime">-</div>
                        <div class="metric-label">
                            <i class="fas fa-bolt me-1"></i>处理时间
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="metric-card">
                        <i class="fas fa-shield-check fa-2x" id="securityIcon"></i>
                        <div class="metric-value" id="securityLevel">-</div>
                        <div class="metric-label">
                            <i class="fas fa-lock me-1"></i>安全等级
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="metric-card">
                        <i class="fas fa-microchip fa-2x text-primary"></i>
                        <div class="metric-value text-primary" id="cpuUsage">-</div>
                        <div class="metric-label">CPU占用</div>
                    </div>
                </div>
            </div>

            <!-- 增强流量分类统计 -->
            <div class="row mb-4" id="enhancedClassificationSection" style="display: none;">
                <div class="col-md-12">
                    <div class="analysis-card">
                        <h5><i class="fas fa-search-plus me-2"></i>智能流量分类统计</h5>
                        <div class="row">
                            <!-- 正常流量统计 -->
                            <div class="col-md-6">
                                <div class="classification-group">
                                    <h6 class="text-success"><i class="fas fa-check-circle me-2"></i>正常流量</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="classification-metric">
                                                <div class="classification-value text-primary" id="httpTraffic">-</div>
                                                <div class="classification-label">HTTP流量</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="classification-metric">
                                                <div class="classification-value text-info" id="dnsTraffic">-</div>
                                                <div class="classification-label">DNS流量</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="classification-metric">
                                                <div class="classification-value text-secondary" id="videoTraffic">-</div>
                                                <div class="classification-label">视频流量</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="classification-metric">
                                                <div class="classification-value text-success" id="otherTraffic">-</div>
                                                <div class="classification-label">其它流量</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 威胁流量统计 -->
                            <div class="col-md-6">
                                <div class="classification-group">
                                    <h6 class="text-danger"><i class="fas fa-shield-alt me-2"></i>威胁流量</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="classification-metric">
                                                <div class="classification-value text-danger" id="maliciousTraffic">-</div>
                                                <div class="classification-label">恶意流量</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="classification-metric">
                                                <div class="classification-value text-warning" id="suspiciousTraffic">-</div>
                                                <div class="classification-label">可疑流量</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 威胁导出功能 -->
                                    <div class="mt-3" id="threatExportSection" style="display: none;">
                                        <button class="btn btn-danger btn-sm" id="exportThreatsBtn">
                                            <i class="fas fa-download me-2"></i>导出威胁流量CSV
                                        </button>
                                        <div id="exportStatus" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 智能流量分类可视化饼图 -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <h6 class="text-primary"><i class="fas fa-chart-pie me-2"></i>流量分类可视化</h6>
                                <div class="chart-container" style="height: 400px;">
                                    <canvas id="trafficClassificationChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI准确率指标 -->
            <div class="row mb-4" id="accuracySection" style="display: none;">
                <div class="col-md-12">
                    <div class="analysis-card">
                        <h5><i class="fas fa-brain me-2"></i>AI白名单过滤准确率</h5>
                        <div class="row">
                            <!-- 总体准确率 -->
                            <div class="col-md-3">
                                <div class="accuracy-metric">
                                    <div class="accuracy-circle">
                                        <canvas id="overallAccuracyChart" width="80" height="80"></canvas>
                                        <div class="accuracy-value" id="overallAccuracy">-</div>
                                    </div>
                                    <div class="accuracy-label">总体准确率</div>
                                </div>
                            </div>
                            
                            <!-- 白名单准确率 -->
                            <div class="col-md-3">
                                <div class="accuracy-metric">
                                    <div class="accuracy-circle">
                                        <canvas id="whitelistAccuracyChart" width="80" height="80"></canvas>
                                        <div class="accuracy-value" id="whitelistAccuracy">-</div>
                                    </div>
                                    <div class="accuracy-label">白名单准确率</div>
                                </div>
                            </div>
                            
                            <!-- 误报率 -->
                            <div class="col-md-3">
                                <div class="accuracy-metric">
                                    <div class="accuracy-circle">
                                        <canvas id="falsePositiveChart" width="80" height="80"></canvas>
                                        <div class="accuracy-value" id="falsePositiveRate">-</div>
                                    </div>
                                    <div class="accuracy-label">误报率</div>
                                </div>
                            </div>
                            
                            <!-- 漏报率 -->
                            <div class="col-md-3">
                                <div class="accuracy-metric">
                                    <div class="accuracy-circle">
                                        <canvas id="falseNegativeChart" width="80" height="80"></canvas>
                                        <div class="accuracy-value" id="falseNegativeRate">-</div>
                                    </div>
                                    <div class="accuracy-label">漏报率</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 详细指标 -->
                        <div class="row mt-4" id="detailedMetrics">
                            <div class="col-md-3">
                                <div class="detail-metric">
                                    <div class="detail-value text-success" id="truePositive">-</div>
                                    <div class="detail-label">正确识别正常流量</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="detail-metric">
                                    <div class="detail-value text-danger" id="falsePositive">-</div>
                                    <div class="detail-label">误识别为正常</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="detail-metric">
                                    <div class="detail-value text-warning" id="falseNegative">-</div>
                                    <div class="detail-label">误识别为攻击</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="detail-metric">
                                    <div class="detail-value text-info" id="trueNegative">-</div>
                                    <div class="detail-label">正确识别攻击</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 准确率说明 -->
                        <div class="mt-3" id="accuracyExplanation">
                            <div class="alert alert-light" role="alert">
                                <h6><i class="fas fa-info-circle me-2"></i>准确率指标说明</h6>
                                <ul class="mb-0">
                                    <li><strong>总体准确率</strong>：AI正确分类的流量占总流量的比例</li>
                                    <li><strong>白名单准确率</strong>：正确识别为正常流量的正常流量占所有正常流量的比例</li>
                                    <li><strong>误报率</strong>：错误识别为正常流量的攻击流量占所有攻击流量的比例</li>
                                    <li><strong>漏报率</strong>：错误识别为攻击流量的正常流量占所有正常流量的比例</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 协议分析图表 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="analysis-card">
                        <h5><i class="fas fa-network-wired me-2"></i>网络协议分布</h5>
                        <div class="chart-container">
                            <canvas id="protocolChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="analysis-card">
                        <h5><i class="fas fa-server me-2"></i>服务类型分布</h5>
                        <div class="chart-container">
                            <canvas id="serviceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 流量模式分析 -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="analysis-card">
                        <h5><i class="fas fa-chart-bar me-2"></i>流量大小分布</h5>
                        <div class="chart-container">
                            <canvas id="trafficPatternChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 安全分析表格 -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="analysis-card">
                        <h5><i class="fas fa-shield-alt me-2"></i>安全分析详情</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>分析项目</th>
                                        <th>检测结果</th>
                                        <th>风险等级</th>
                                        <th>详细信息</th>
                                    </tr>
                                </thead>
                                <tbody id="securityTableBody">
                                    <!-- 安全分析结果将动态插入这里 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="row">
                <div class="col-md-12 text-center">
                    <button class="btn btn-primary btn-custom me-3" onclick="downloadReport()">
                        <i class="fas fa-file-pdf me-2"></i>下载PDF报告
                    </button>
                    <button class="btn btn-success btn-custom me-3" onclick="exportCSV()">
                        <i class="fas fa-file-csv me-2"></i>导出数据
                    </button>
                    <button class="btn btn-info btn-custom" onclick="resetAnalysis()">
                        <i class="fas fa-redo me-2"></i>重新分析
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载覆盖层 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border spinner-border-custom text-light" role="status"></div>
        <h4 class="mt-3">AI正在分析中...</h4>
        <p class="text-light">请稍候，正在处理您的数据</p>
    </div>

    <!-- 历史记录模态框 -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-history me-2"></i>分析历史记录
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 过滤器 -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select class="form-select" id="statusFilter" onchange="loadHistory()">
                                <option value="">所有状态</option>
                                <option value="completed">已完成</option>
                                <option value="pending">进行中</option>
                                <option value="failed">失败</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary" onclick="loadHistory()">
                                <i class="fas fa-sync me-1"></i>刷新
                            </button>
                            <button class="btn btn-danger ms-2" onclick="clearAllHistory()">
                                <i class="fas fa-trash me-1"></i>清空历史
                            </button>
                        </div>
                    </div>
                    
                    <!-- 历史记录表格 -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>文件名</th>
                                    <th>上传时间</th>
                                    <th>完成时间</th>
                                    <th>AI分析用时</th>
                                    <th>流量数</th>
                                    <th>异常数</th>
                                    <th>安全等级</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="9" class="text-center">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页 -->
                    <nav>
                        <ul class="pagination justify-content-center" id="historyPagination">
                            <!-- 分页按钮将动态生成 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 历史记录详情模态框 -->
    <div class="modal fade" id="historyDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line me-2"></i>分析详情
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="historyDetailContent">
                    <!-- 详情内容将动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 全局变量
        let analysisResults = null;
        let currentTaskId = null; // 当前任务ID
        let charts = {
            protocol: null,
            service: null,
            trafficPattern: null,
            trafficClassification: null
        };
        
        // 历史记录管理
        let historyManager = {
            currentPage: 1,
            pageSize: 10,
            totalPages: 1,
            
            // 加载历史记录
            async loadHistory(page = 1, status = '') {
                try {
                    console.log(`加载历史记录: page=${page}, status=${status}`);
                    const response = await fetch(`/api/history?page=${page}&limit=${this.pageSize}&status=${status}`);
                    const data = await response.json();
                    
                    console.log('历史记录响应:', data);
                    
                    if (data.success) {
                        this.currentPage = data.page;
                        this.renderHistoryTable(data.data);
                        this.renderPagination();
                        
                        // 显示加载成功信息
                        if (data.data.length > 0) {
                            console.log(`✅ 成功加载 ${data.data.length} 条历史记录`);
                        } else {
                            console.log('ℹ️ 暂无历史记录');
                        }
                    } else {
                        console.error('历史记录加载失败:', data.error);
                        showAlert('加载历史记录失败: ' + data.error, 'danger');
                        // 显示空表格
                        this.renderHistoryTable([]);
                    }
                } catch (error) {
                    console.error('加载历史记录错误:', error);
                    showAlert('网络错误，无法加载历史记录', 'danger');
                    // 显示空表格
                    this.renderHistoryTable([]);
                }
            },
            
            // 渲染历史记录表格
            renderHistoryTable(records) {
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';
                
                if (records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无记录</td></tr>';
                    return;
                }
                
                // 按上传时间从近到远排序（最新的在前面）
                const sortedRecords = [...records].sort((a, b) => {
                    const timeA = new Date(a.upload_time).getTime();
                    const timeB = new Date(b.upload_time).getTime();
                    return timeB - timeA; // 降序排列，最新时间在前
                });
                
                sortedRecords.forEach(record => {
                    const row = document.createElement('tr');
                    
                    // 健壮的时间格式化函数
                    function formatDateTime(dateStr) {
                        if (!dateStr) return '-';
                        try {
                            const date = new Date(dateStr);
                            if (isNaN(date.getTime())) {
                                // 如果无法解析，尝试其他格式
                                console.warn('时间格式解析失败:', dateStr);
                                return dateStr; // 返回原始字符串
                            }
                            return date.toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                        } catch (error) {
                            console.error('时间格式化错误:', error, dateStr);
                            return dateStr;
                        }
                    }
                    
                    // 格式化时间
                    const uploadTime = formatDateTime(record.upload_time);
                    const completionTime = formatDateTime(record.analysis_time);
                    
                    // 格式化AI分析用时
                    let aiProcessingTime = '-';
                    if (record.processing_time && !isNaN(record.processing_time)) {
                        aiProcessingTime = `${parseFloat(record.processing_time).toFixed(2)}s`;
                    }
                    
                    // 安全等级显示
                    let securityBadge = '';
                    switch(record.security_level) {
                        case 'safe':
                            securityBadge = '<span class="badge bg-success">安全</span>';
                            break;
                        case 'medium_risk':
                            securityBadge = '<span class="badge bg-warning">中等</span>';
                            break;
                        case 'high_risk':
                            securityBadge = '<span class="badge bg-danger">高风险</span>';
                            break;
                        default:
                            securityBadge = '<span class="badge bg-secondary">-</span>';
                    }
                    
                    // 状态显示
                    let statusBadge = '';
                    switch(record.status) {
                        case 'completed':
                            statusBadge = '<span class="badge bg-success">已完成</span>';
                            break;
                        case 'pending':
                            statusBadge = '<span class="badge bg-warning">进行中</span>';
                            break;
                        case 'failed':
                            statusBadge = '<span class="badge bg-danger">失败</span>';
                            break;
                        default:
                            statusBadge = '<span class="badge bg-secondary">未知</span>';
                    }
                    
                    // 安全地获取数值，避免显示异常
                    const totalFlows = record.total_flows && !isNaN(record.total_flows) ? 
                        parseInt(record.total_flows).toLocaleString() : '-';
                    const anomalyCount = record.anomaly_count !== null && 
                        record.anomaly_count !== undefined && !isNaN(record.anomaly_count) ? 
                        parseInt(record.anomaly_count).toLocaleString() : '0';
                    
                    // 文件大小格式化
                    const fileSize = record.file_size ? this.formatFileSize(record.file_size) : '-';
                    
                    // 确保filename存在
                    const filename = record.filename || '未知文件';
                    
                    row.innerHTML = `
                        <td>
                            <i class="fas fa-file me-1"></i>
                            ${filename}
                            <small class="text-muted d-block">${fileSize}</small>
                        </td>
                        <td>${uploadTime}</td>
                        <td>${completionTime}</td>
                        <td><span class="badge bg-info">${aiProcessingTime}</span></td>
                        <td>${totalFlows}</td>
                        <td>${anomalyCount}</td>
                        <td>${securityBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${record.status === 'completed' ? 
                                `<button class="btn btn-sm btn-primary me-1" onclick="viewHistoryDetail('${record.task_id}')" title="查看详情">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-success me-1" onclick="reloadAnalysis('${record.task_id}')" title="重新加载">
                                    <i class="fas fa-redo"></i>
                                </button>` : ''
                            }
                            <button class="btn btn-sm btn-danger" onclick="deleteHistoryRecord('${record.task_id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            },
            
            // 格式化文件大小
            formatFileSize(bytes) {
                if (!bytes) return '-';
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },
            
            // 渲染分页
            renderPagination() {
                const pagination = document.getElementById('historyPagination');
                pagination.innerHTML = '';
                
                // 上一页
                if (this.currentPage > 1) {
                    pagination.innerHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="historyManager.loadHistory(${this.currentPage - 1})">上一页</a>
                        </li>
                    `;
                }
                
                // 页码 (显示当前页及前后各2页)
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(this.totalPages, this.currentPage + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    pagination.innerHTML += `
                        <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="historyManager.loadHistory(${i})">${i}</a>
                        </li>
                    `;
                }
                
                // 下一页
                if (this.currentPage < this.totalPages) {
                    pagination.innerHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="historyManager.loadHistory(${this.currentPage + 1})">下一页</a>
                        </li>
                    `;
                }
            }
        };
        
        // 系统性能监控
        let performanceMonitor = {
            startTime: null,
            startMemory: null,
            isMonitoring: false,
            
            // 开始监控
            start() {
                this.startTime = performance.now();
                this.isMonitoring = true;
                
                // 获取初始内存信息（如果浏览器支持）
                if (performance.memory) {
                    this.startMemory = performance.memory.usedJSHeapSize;
                }
                
                // 开始CPU监控
                this.startCpuMonitoring();
            },
            
            // 停止监控并获取结果
            stop() {
                this.isMonitoring = false;
                const endTime = performance.now();
                const processingTime = (endTime - this.startTime) / 1000;
                
                let memoryUsed = 0;
                if (performance.memory && this.startMemory) {
                    const currentMemory = performance.memory.usedJSHeapSize;
                    memoryUsed = Math.max(0, (currentMemory - this.startMemory) / (1024 * 1024)); // 转换为MB
                }
                
                return {
                    processingTime: processingTime,
                    memoryUsed: memoryUsed,
                    cpuUsage: this.getCurrentCpuUsage()
                };
            },
            
            // CPU监控（基于计算密集度估算）
            startCpuMonitoring() {
                this.cpuStartTime = performance.now();
                this.cpuSamples = [];
                
                if (this.isMonitoring) {
                    this.sampleCpu();
                }
            },
            
            // CPU采样
            sampleCpu() {
                if (!this.isMonitoring) return;
                
                const start = performance.now();
                // 执行一些计算来测量CPU响应时间
                for (let i = 0; i < 10000; i++) {
                    Math.random() * Math.random();
                }
                const end = performance.now();
                
                this.cpuSamples.push(end - start);
                
                // 继续采样
                setTimeout(() => this.sampleCpu(), 100);
            },
            
            // 获取当前CPU使用率估算
            getCurrentCpuUsage() {
                if (!this.cpuSamples || this.cpuSamples.length === 0) return 0;
                
                const avgTime = this.cpuSamples.reduce((a, b) => a + b, 0) / this.cpuSamples.length;
                // 基准时间约0.1ms，超过此时间认为CPU占用较高
                const baselineTime = 0.1;
                const cpuUsage = Math.min(100, Math.max(0, (avgTime / baselineTime - 1) * 50 + 10));
                
                return cpuUsage;
            },
            
            // 获取内存信息
            getMemoryInfo() {
                if (performance.memory) {
                    return {
                        used: (performance.memory.usedJSHeapSize / (1024 * 1024)).toFixed(2),
                        total: (performance.memory.totalJSHeapSize / (1024 * 1024)).toFixed(2),
                        limit: (performance.memory.jsHeapSizeLimit / (1024 * 1024)).toFixed(2)
                    };
                }
                return null;
            }
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            setupEventListeners();
            initializeTheme();
            
            // 启动流量动画效果
            initializeTrafficAnimations();
            
            // 启动实时性能监控
            startRealtimePerformanceMonitoring();
        });
        
        // 初始化流量动画效果
        function initializeTrafficAnimations() {
            createDataPacketAnimation();
            createNetworkTopology();
            startTrafficFlow();
        }
        
        // 创建数据包动画
        function createDataPacketAnimation() {
            const trafficAnimation = document.querySelector('.traffic-animation');
            if (!trafficAnimation) return;
            
            function createPacket() {
                const packet = document.createElement('div');
                packet.className = 'data-packet';
                packet.style.top = Math.random() * 100 + '%';
                packet.style.animationDelay = Math.random() * 2 + 's';
                packet.style.animationDuration = (2 + Math.random() * 3) + 's';
                
                trafficAnimation.appendChild(packet);
                
                // 动画结束后移除元素
                setTimeout(() => {
                    if (packet.parentNode) {
                        packet.parentNode.removeChild(packet);
                    }
                }, 5000);
            }
            
            // 每隔一段时间创建新的数据包
            setInterval(createPacket, 800);
        }
        
        // 创建网络拓扑节点
        function createNetworkTopology() {
            const topologies = document.querySelectorAll('.network-topology');
            topologies.forEach(topology => {
                if (topology.children.length === 0) {
                    // 创建节点
                    const nodes = [
                        {top: 5, left: 5},
                        {top: 15, left: 25, delay: 0.5},
                        {top: 35, left: 15, delay: 1},
                        {top: 25, left: 45, delay: 1.5}
                    ];
                    
                    nodes.forEach(node => {
                        const nodeEl = document.createElement('div');
                        nodeEl.className = 'network-node';
                        nodeEl.style.top = node.top + 'px';
                        nodeEl.style.left = node.left + 'px';
                        if (node.delay) {
                            nodeEl.style.animationDelay = node.delay + 's';
                        }
                        topology.appendChild(nodeEl);
                    });
                    
                    // 创建连接线
                    const lines = [
                        {top: 10, left: 10, width: 20, angle: 45},
                        {top: 25, left: 15, width: 15, angle: -30},
                        {top: 30, left: 30, width: 18, angle: 60}
                    ];
                    
                    lines.forEach(line => {
                        const lineEl = document.createElement('div');
                        lineEl.className = 'network-line';
                        lineEl.style.top = line.top + 'px';
                        lineEl.style.left = line.left + 'px';
                        lineEl.style.width = line.width + 'px';
                        lineEl.style.transform = `rotate(${line.angle}deg)`;
                        topology.appendChild(lineEl);
                    });
                }
            });
        }
        
        // 启动流量流动效果
        function startTrafficFlow() {
            const flowElements = document.querySelectorAll('.data-flow');
            flowElements.forEach(element => {
                setInterval(() => {
                    element.style.animation = 'none';
                    setTimeout(() => {
                        element.style.animation = '';
                    }, 10);
                }, 3000);
            });
        }
        
        // 结果显示动画效果
        function animateResultsDisplay() {
            const resultsContainer = document.getElementById('resultsContainer');
            if (resultsContainer) {
                resultsContainer.style.opacity = '0';
                resultsContainer.style.transform = 'translateY(20px)';
                resultsContainer.style.transition = 'all 0.8s ease-out';
                
                setTimeout(() => {
                    resultsContainer.style.opacity = '1';
                    resultsContainer.style.transform = 'translateY(0)';
                }, 100);
            }
        }
        
        // 指标更新动画
        function animateMetricUpdate(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.transform = 'scale(1.1)';
                element.style.transition = 'transform 0.3s ease';
                element.textContent = newValue;
                
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 300);
            }
        }
        
        // 流量数据可视化强化效果
        function enhanceTrafficVisualization() {
            // 为所有图表添加入场动画
            const charts = document.querySelectorAll('.chart-container');
            charts.forEach((chart, index) => {
                chart.style.opacity = '0';
                chart.style.transform = 'translateX(30px)';
                chart.style.transition = 'all 0.6s ease-out';
                
                setTimeout(() => {
                    chart.style.opacity = '1';
                    chart.style.transform = 'translateX(0)';
                }, 200 * (index + 1));
            });
        }
        
        // 启动实时性能监控
        function startRealtimePerformanceMonitoring() {
            setInterval(() => {
                // 只在分析过程中或有结果时更新性能指标
                const progressSection = document.getElementById('progressSection');
                const resultsContainer = document.getElementById('resultsContainer');
                
                if (!progressSection.classList.contains('d-none') || 
                    (resultsContainer && resultsContainer.style.display === 'block')) {
                    updateRealtimePerformance();
                }
            }, 2000); // 每2秒更新一次
        }
        
        // 实时性能更新
        function updateRealtimePerformance() {
            const cpuUsage = estimateCpuUsage();
            const memoryInfo = getMemoryUsage();
            
            // 更新CPU显示
            const cpuElement = document.getElementById('cpuUsage');
            const cpuIcon = cpuElement.parentElement.querySelector('i');
            
            if (cpuElement.textContent === '-') {
                cpuElement.textContent = cpuUsage.toFixed(1) + '%';
                
                if (cpuUsage > 80) {
                    cpuElement.className = 'metric-value text-danger';
                    cpuIcon.className = 'fas fa-microchip fa-2x text-danger';
                } else if (cpuUsage > 50) {
                    cpuElement.className = 'metric-value text-warning';
                    cpuIcon.className = 'fas fa-microchip fa-2x text-warning';
                } else {
                    cpuElement.className = 'metric-value text-primary';
                    cpuIcon.className = 'fas fa-microchip fa-2x text-primary';
                }
            }
            
            // 更新内存显示
            const memoryElement = document.getElementById('memoryUsage');
            const memoryIcon = memoryElement.parentElement.querySelector('i');
            
            if (memoryElement.textContent === '-') {
                memoryElement.textContent = memoryInfo.display;
                
                if (memoryInfo.percentage > 80) {
                    memoryElement.className = 'metric-value text-danger';
                    memoryIcon.className = 'fas fa-memory fa-2x text-danger';
                } else if (memoryInfo.percentage > 60) {
                    memoryElement.className = 'metric-value text-warning';
                    memoryIcon.className = 'fas fa-memory fa-2x text-warning';
                } else {
                    memoryElement.className = 'metric-value text-secondary';
                    memoryIcon.className = 'fas fa-memory fa-2x text-secondary';
                }
            }
        }

        // 初始化主题
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        }

        // 切换主题
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // 应用主题
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const themeIcon = document.getElementById('themeIcon');
            
            if (theme === 'dark') {
                themeIcon.className = 'fas fa-sun';
                themeIcon.parentElement.title = '切换到亮色主题';
            } else {
                themeIcon.className = 'fas fa-moon';
                themeIcon.parentElement.title = '切换到暗色主题';
            }
            
            // 更新图表主题
            updateChartsTheme(theme);
        }

        // 更新图表主题
        function updateChartsTheme(theme) {
            const textColor = theme === 'dark' ? '#ffffff' : '#333333';
            const gridColor = theme === 'dark' ? '#4a5568' : '#e9ecef';
            
            // 更新所有现有图表的颜色
            Object.values(charts).forEach(chart => {
                if (chart) {
                    if (chart.options.scales) {
                        if (chart.options.scales.x) {
                            chart.options.scales.x.ticks = { ...chart.options.scales.x.ticks, color: textColor };
                            chart.options.scales.x.grid = { ...chart.options.scales.x.grid, color: gridColor };
                        }
                        if (chart.options.scales.y) {
                            chart.options.scales.y.ticks = { ...chart.options.scales.y.ticks, color: textColor };
                            chart.options.scales.y.grid = { ...chart.options.scales.y.grid, color: gridColor };
                        }
                    }
                    if (chart.options.plugins && chart.options.plugins.legend) {
                        chart.options.plugins.legend.labels = { 
                            ...chart.options.plugins.legend.labels, 
                            color: textColor 
                        };
                    }
                    chart.update();
                }
            });
        }

        // 更新当前时间 - 使用系统默认格式
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString();
        }

        // 设置事件监听器
        function setupEventListeners() {
            const uploadZone = document.querySelector('.upload-zone');
            const fileInput = document.getElementById('fileInput');

            // 拖拽上传
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // 文件选择
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleFileSelect(this.files[0]);
                }
            });
        }

        // 处理文件选择
        function handleFileSelect(file) {
            const allowedTypes = ['.pcap', '.pcapng', '.csv'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExtension)) {
                showAlert('请上传 PCAP、PCAPNG 或 CSV 格式的文件', 'warning');
                return;
            }

            // 大文件提示
            const fileSizeMB = file.size / (1024 * 1024);
            if (fileSizeMB > 500) {
                showAlert(`检测到大文件 (${fileSizeMB.toFixed(2)}MB)，处理时间可能较长，请耐心等待...`, 'info');
            }

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.remove('d-none');
            
            // 存储文件到全局变量
            window.selectedFile = file;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 清除文件
        function clearFile() {
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').classList.add('d-none');
            window.selectedFile = null;
        }

        // 开始分析
        function startAnalysis() {
            if (!window.selectedFile) {
                showAlert('请先选择文件', 'warning');
                return;
            }

            // 记录开始时间
            const startTime = Date.now();
            
            // 开始全局性能监控
            performanceMonitor.start();

            // 显示进度区域和加载覆盖层
            document.getElementById('progressSection').classList.remove('d-none');
            document.getElementById('loadingOverlay').style.display = 'flex';

            // 准备FormData
            const formData = new FormData();
            formData.append('file', window.selectedFile);

            // 开始同步进度显示
            progressManager.start();

            // 立即推进到文件上传阶段
            setTimeout(() => {
                progressManager.setProgress(10, '正在上传文件...', 1);
            }, 500);

            // 发送分析请求
            fetch('/api/ai_analysis', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // 文件上传完成
                progressManager.setProgress(30, '文件上传完成，服务器开始处理...', 2);
                return response.json();
            })
            .then(data => {
                // 计算总处理时间
                const endTime = Date.now();
                const totalProcessingTime = (endTime - startTime) / 1000;
                
                if (data.success) {
                    // 数据处理完成，推进到AI分析阶段
                    progressManager.setProgress(65, '数据处理完成，AI正在深度分析...', 3);
                    
                    analysisResults = data.result;
                    
                    // 保存任务ID用于后续的CSV导出
                    if (analysisResults && analysisResults.task_id) {
                        currentTaskId = analysisResults.task_id;
                        console.log('保存任务ID:', currentTaskId);
                    }
                    
                    // 将总处理时间添加到结果中
                    if (!analysisResults.basic_info) {
                        analysisResults.basic_info = {};
                    }
                    analysisResults.basic_info.total_processing_time = totalProcessingTime;
                    
                    // AI分析完成，开始生成报告
                    setTimeout(() => {
                        progressManager.setProgress(90, 'AI分析完成，正在生成详细报告...', 4);
                        displayAnalysisResults(analysisResults);
                    }, 800);
                    
                    // 报告生成完成
                    setTimeout(() => {
                        progressManager.complete();
                        
                        setTimeout(() => {
                            document.getElementById('loadingOverlay').style.display = 'none';
                            document.getElementById('resultsContainer').style.display = 'block';
                            showAlert('分析完成！共处理 ' + (analysisResults.basic_info?.total_flows || 0).toLocaleString() + ' 条流量记录，耗时 ' + totalProcessingTime.toFixed(2) + '秒', 'success');
                        }, 1000);
                    }, 1500);
                    
                } else {
                    progressManager.setError('分析失败: ' + data.error);
                    showAlert('分析失败: ' + data.error, 'danger');
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('progressSection').classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('分析错误:', error);
                progressManager.setError('网络连接错误或服务器异常');
                showAlert('分析过程中出现错误: ' + error.message, 'danger');
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('progressSection').classList.add('d-none');
            });
        }

        // 进度管理系统 - 改进版，与实际分析同步
        let progressManager = {
            currentStage: 0,
            isComplete: false,
            startTime: null,
            autoProgressTimer: null,
            stages: [
                { progress: 5, text: '初始化分析环境...', stage: 1, minDuration: 500 },
                { progress: 15, text: '上传文件到服务器...', stage: 1, minDuration: 1000 },
                { progress: 25, text: '验证文件格式...', stage: 1, minDuration: 800 },
                { progress: 35, text: '数据预处理中...', stage: 2, minDuration: 1500 },
                { progress: 45, text: '特征提取中...', stage: 2, minDuration: 2000 },
                { progress: 60, text: 'AI模型加载中...', stage: 3, minDuration: 1200 },
                { progress: 75, text: '智能分析检测中...', stage: 3, minDuration: 3000 },
                { progress: 85, text: '安全评估中...', stage: 3, minDuration: 1500 },
                { progress: 95, text: '生成分析报告...', stage: 4, minDuration: 1000 },
                { progress: 100, text: '分析完成！', stage: 4, minDuration: 500 }
            ],

            // 开始进度更新 - 只做初始化，不自动推进
            start() {
                this.currentStage = 0;
                this.isComplete = false;
                this.startTime = Date.now();
                
                // 初始化第一个阶段
                const firstStage = this.stages[0];
                updateProgress(firstStage.progress, firstStage.text);
                highlightStage(firstStage.stage);
                this.currentStage = 1;
            },

            // 手动推进到特定阶段 - 改进版
            advanceToStage(targetStage, customText, forceProgress) {
                // 停止自动进度更新
                if (this.autoProgressTimer) {
                    clearTimeout(this.autoProgressTimer);
                    this.autoProgressTimer = null;
                }

                // 找到目标阶段
                let targetIndex = -1;
                if (typeof targetStage === 'number') {
                    // 如果是阶段号，找到该阶段的最后一个步骤
                    for (let i = this.stages.length - 1; i >= 0; i--) {
                        if (this.stages[i].stage === targetStage) {
                            targetIndex = i;
                            break;
                        }
                    }
                } else {
                    // 如果是具体进度值
                    targetIndex = targetStage;
                }

                if (targetIndex !== -1 && targetIndex >= this.currentStage) {
                    const targetStageData = this.stages[targetIndex];
                    
                    // 逐步推进到目标阶段
                    this.smoothAdvanceToIndex(targetIndex, customText || targetStageData.text);
                } else if (forceProgress !== undefined) {
                    // 强制设置特定进度
                    updateProgress(forceProgress, customText || '处理中...');
                }
            },

            // 平滑推进到指定索引
            smoothAdvanceToIndex(targetIndex, finalText) {
                if (this.currentStage > targetIndex) return;

                const currentStageData = this.stages[this.currentStage];
                updateProgress(currentStageData.progress, currentStageData.text);
                highlightStage(currentStageData.stage);

                if (this.currentStage < targetIndex) {
                    this.currentStage++;
                    this.autoProgressTimer = setTimeout(() => {
                        this.smoothAdvanceToIndex(targetIndex, finalText);
                    }, 300); // 快速推进
                } else {
                    // 到达目标，设置最终文本
                    setTimeout(() => {
                        updateProgress(this.stages[targetIndex].progress, finalText);
                    }, 100);
                }
            },

            // 设置具体进度值
            setProgress(percentage, text, stageNumber) {
                if (this.autoProgressTimer) {
                    clearTimeout(this.autoProgressTimer);
                    this.autoProgressTimer = null;
                }
                
                updateProgress(percentage, text);
                if (stageNumber) {
                    highlightStage(stageNumber);
                }
            },

            // 快速完成进度
            complete() {
                this.isComplete = true;
                if (this.autoProgressTimer) {
                    clearTimeout(this.autoProgressTimer);
                }
                
                this.currentStage = this.stages.length - 1;
                const finalStage = this.stages[this.currentStage];
                updateProgress(finalStage.progress, finalStage.text);
                highlightStage(finalStage.stage);
                
                // 标记所有阶段为完成
                setTimeout(() => {
                    for (let i = 1; i <= 4; i++) {
                        highlightStage(i, true); // true表示完成状态
                    }
                }, 500);
            },

            // 设置错误状态
            setError(errorText) {
                this.isComplete = true;
                if (this.autoProgressTimer) {
                    clearTimeout(this.autoProgressTimer);
                }
                
                updateProgress(0, errorText || '分析过程中出现错误');
                // 重置所有阶段高亮
                document.querySelectorAll('.stage-indicator').forEach(el => {
                    el.classList.remove('text-primary', 'text-success');
                    el.classList.add('text-danger');
                    el.style.color = '#dc3545';
                });
            },

            // 重置进度管理器
            reset() {
                if (this.autoProgressTimer) {
                    clearTimeout(this.autoProgressTimer);
                }
                this.currentStage = 0;
                this.isComplete = false;
                this.startTime = null;
                this.autoProgressTimer = null;
            }
        };

        // 智能进度更新（替代原来的simulateProgress）
        function simulateProgress() {
            progressManager.start();
        }

        // 更新进度条 - 增强版
        function updateProgress(percentage, text) {
            const progressBar = document.getElementById('analysisProgress');
            const progressText = document.getElementById('progressText');
            
            if (progressBar && progressText) {
                // 平滑更新进度条
                progressBar.style.transition = 'width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                progressBar.style.width = percentage + '%';
                
                // 根据进度改变颜色
                if (percentage < 30) {
                    progressBar.className = 'progress-bar bg-info';
                } else if (percentage < 70) {
                    progressBar.className = 'progress-bar bg-warning';
                } else if (percentage < 100) {
                    progressBar.className = 'progress-bar bg-primary';
                } else {
                    progressBar.className = 'progress-bar bg-success';
                }
                
                // 添加文字淡入效果
                progressText.style.opacity = '0';
                setTimeout(() => {
                    progressText.textContent = text;
                    progressText.style.transition = 'opacity 0.3s ease-in-out';
                    progressText.style.opacity = '1';
                }, 150);
                
                // 更新加载覆盖层的文本
                const loadingText = document.querySelector('#loadingOverlay h4');
                if (loadingText && percentage < 100) {
                    loadingText.textContent = text;
                }
                
                // 添加进度完成时的特效
                if (percentage === 100) {
                    setTimeout(() => {
                        progressBar.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.6)';
                        progressText.style.color = '#28a745';
                        progressText.style.fontWeight = 'bold';
                    }, 600);
                }
            }
        }

        // 高亮显示当前阶段 - 增强版，支持完成状态
        function highlightStage(stageNumber, isCompleted = false) {
            // 重置所有阶段样式
            document.querySelectorAll('.stage-indicator').forEach((el, index) => {
                const currentStageNum = index + 1;
                el.style.transition = 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                
                if (isCompleted || currentStageNum < stageNumber) {
                    // 已完成的阶段
                    el.classList.remove('text-primary', 'text-muted', 'text-danger');
                    el.classList.add('text-success');
                    el.style.transform = 'scale(1.05)';
                    el.style.background = 'rgba(40, 167, 69, 0.1)';
                    el.style.borderRadius = '15px';
                    el.style.padding = '15px';
                    el.style.boxShadow = '0 4px 15px rgba(40, 167, 69, 0.2)';
                    
                    // 添加完成图标效果
                    const icon = el.querySelector('i');
                    if (icon) {
                        icon.style.animation = 'none';
                        icon.style.filter = 'drop-shadow(0 0 8px rgba(40, 167, 69, 0.6))';
                    }
                } else if (currentStageNum === stageNumber && !isCompleted) {
                    // 当前活跃阶段
                    el.classList.remove('text-success', 'text-muted', 'text-danger');
                    el.classList.add('text-primary');
                    el.style.transform = 'scale(1.1)';
                    el.style.background = 'rgba(52, 152, 219, 0.15)';
                    el.style.borderRadius = '15px';
                    el.style.padding = '15px';
                    el.style.boxShadow = '0 8px 25px rgba(52, 152, 219, 0.3)';
                    
                    // 添加脉动效果
                    const icon = el.querySelector('i');
                    if (icon) {
                        icon.style.animation = 'pulse 1.5s ease-in-out infinite';
                        icon.style.filter = 'drop-shadow(0 0 10px rgba(52, 152, 219, 0.8))';
                    }
                } else {
                    // 未完成的阶段
                    el.classList.remove('text-primary', 'text-success', 'text-danger');
                    el.classList.add('text-muted');
                    el.style.transform = 'scale(1)';
                    el.style.background = 'transparent';
                    el.style.boxShadow = 'none';
                    el.style.padding = '15px';
                    
                    const icon = el.querySelector('i');
                    if (icon) {
                        icon.style.animation = 'none';
                        icon.style.filter = 'none';
                    }
                }
            });
            
            // 添加CSS动画定义（如果还没有）
            if (!document.getElementById('stageAnimations')) {
                const style = document.createElement('style');
                style.id = 'stageAnimations';
                style.textContent = `
                    @keyframes pulse {
                        0%, 100% { 
                            transform: scale(1);
                            opacity: 1;
                        }
                        50% { 
                            transform: scale(1.1);
                            opacity: 0.8;
                        }
                    }
                    
                    @keyframes completeBounce {
                        0%, 20%, 50%, 80%, 100% {
                            transform: scale(1.05);
                        }
                        40% {
                            transform: scale(1.15);
                        }
                        60% {
                            transform: scale(1.1);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // 显示分析结果
        function displayAnalysisResults(results) {
            // 开始性能监控
            const renderStartTime = performance.now();
            performanceMonitor.start();
            
            // 添加结果显示动画效果
            animateResultsDisplay();
            
            // 更新核心指标
            animateMetricUpdate('totalFlows', (results.basic_info?.total_flows || 0).toLocaleString());
            
            // 优先使用总处理时间，如果没有则使用服务器返回的处理时间
            const processingTime = results.basic_info?.total_processing_time || results.basic_info?.processing_time || 0;
            animateMetricUpdate('processingTime', processingTime.toFixed(2) + 's');

            // 更新安全等级
            updateSecurityLevel(results);

            // 显示和更新增强流量分类结果
            updateEnhancedClassification(results);

            // 显示AI准确率指标
            console.log('前端接收到的完整results:', results);
            console.log('前端接收到的accuracy_metrics:', results.accuracy_metrics);
            updateAccuracyMetrics(results);

            // 创建图表
            createCharts(results);

            // 更新安全分析表格
            updateSecurityTable(results);
            
            // 性能监控 - 延迟获取最终数据以确保准确性
            setTimeout(() => {
                updatePerformanceMetrics(renderStartTime);
            }, 1000);
        }

        // 更新增强流量分类展示
        function updateEnhancedClassification(results) {
            const enhanced = results.enhanced_classification;
            const enhancedSection = document.getElementById('enhancedClassificationSection');
            
            if (enhanced && enhanced.classification_summary) {
                console.log('显示增强流量分类结果:', enhanced);
                
                // 显示分类统计区域
                enhancedSection.style.display = 'block';
                
                const summary = enhanced.classification_summary;
                const normalDetails = enhanced.normal_traffic_details || {};
                const maliciousDetails = enhanced.malicious_traffic_details || {};
                
                // 获取流量统计数据
                const httpCount = normalDetails.http_traffic?.count || 0;
                const dnsCount = normalDetails.dns_traffic?.count || 0;
                const videoCount = normalDetails.video_traffic?.count || 0;
                const maliciousCount = summary.malicious_flows || 0;
                const suspiciousCount = summary.suspicious_flows || 0;
                const totalFlows = results.basic_info?.total_flows || 0;
                
                // 实际正常流量 = 总流量 - 威胁流量
                const actualNormalFlows = totalFlows - maliciousCount - suspiciousCount;
                // 其它正常流量 = 实际正常流量 - HTTP - DNS - 视频
                const otherCount = Math.max(0, actualNormalFlows - httpCount - dnsCount - videoCount);
                
                // 所有占比基于总流量计算
                const httpPercentage = totalFlows > 0 ? (httpCount / totalFlows) * 100 : 0;
                const dnsPercentage = totalFlows > 0 ? (dnsCount / totalFlows) * 100 : 0;
                const videoPercentage = totalFlows > 0 ? (videoCount / totalFlows) * 100 : 0;
                const otherPercentage = totalFlows > 0 ? (otherCount / totalFlows) * 100 : 0;
                
                // 更新正常流量统计（占比基于总流量）
                document.getElementById('httpTraffic').textContent = 
                    `${httpCount} 条 (${httpPercentage.toFixed(1)}%)`;
                    
                document.getElementById('dnsTraffic').textContent = 
                    `${dnsCount} 条 (${dnsPercentage.toFixed(1)}%)`;
                    
                document.getElementById('videoTraffic').textContent = 
                    `${videoCount} 条 (${videoPercentage.toFixed(1)}%)`;
                
                document.getElementById('otherTraffic').textContent = 
                    `${otherCount} 条 (${otherPercentage.toFixed(1)}%)`;

                console.log('流量统计计算 - 所有占比基于总流量:', {
                    总流量: totalFlows,
                    HTTP: `${httpCount}条(${httpPercentage.toFixed(1)}%)`,
                    DNS: `${dnsCount}条(${dnsPercentage.toFixed(1)}%)`,
                    视频: `${videoCount}条(${videoPercentage.toFixed(1)}%)`,
                    其它: `${otherCount}条(${otherPercentage.toFixed(1)}%)`,
                    恶意: `${maliciousCount}条(${(maliciousCount/totalFlows*100).toFixed(1)}%)`,
                    可疑: `${suspiciousCount}条(${(suspiciousCount/totalFlows*100).toFixed(1)}%)`
                });

                // 更新威胁流量统计（占比基于总流量）
                const maliciousPercentage = totalFlows > 0 ? (maliciousCount / totalFlows) * 100 : 0;
                const suspiciousPercentage = totalFlows > 0 ? (suspiciousCount / totalFlows) * 100 : 0;
                
                document.getElementById('maliciousTraffic').textContent = 
                    `${maliciousCount} 条 (${maliciousPercentage.toFixed(1)}%)`;
                    
                document.getElementById('suspiciousTraffic').textContent = 
                    `${suspiciousCount} 条 (${suspiciousPercentage.toFixed(1)}%)`;

                // 如果有威胁流量，显示导出功能
                const threatCount = (summary.malicious_flows || 0) + (summary.suspicious_flows || 0);
                const threatExportSection = document.getElementById('threatExportSection');
                
                if (threatCount > 0) {
                    threatExportSection.style.display = 'block';
                    setupThreatExport();
                } else {
                    threatExportSection.style.display = 'none';
                }
                
                // 创建智能流量分类饼图
                createTrafficClassificationChart({
                    httpCount,
                    dnsCount,
                    videoCount,
                    otherCount,
                    maliciousCount,
                    suspiciousCount,
                    httpPercentage,
                    dnsPercentage,
                    videoPercentage,
                    otherPercentage,
                    maliciousPercentage,
                    suspiciousPercentage
                });
                
                // 添加动画效果
                enhancedSection.style.opacity = '0';
                enhancedSection.style.transform = 'translateY(20px)';
                enhancedSection.style.transition = 'all 0.5s ease';
                
                setTimeout(() => {
                    enhancedSection.style.opacity = '1';
                    enhancedSection.style.transform = 'translateY(0)';
                }, 100);
                
            } else {
                console.log('没有增强流量分类数据');
                enhancedSection.style.display = 'none';
            }
        }

        // 设置威胁导出功能
        function setupThreatExport() {
            const exportBtn = document.getElementById('exportThreatsBtn');
            const exportStatus = document.getElementById('exportStatus');
            
            // 移除之前的事件监听器
            const newExportBtn = exportBtn.cloneNode(true);
            exportBtn.parentNode.replaceChild(newExportBtn, exportBtn);
            
            newExportBtn.onclick = async function() {
                if (!currentTaskId) {
                    exportStatus.innerHTML = '<span class="text-danger">❌ 任务ID缺失，无法导出</span>';
                    return;
                }
                
                try {
                    exportStatus.innerHTML = '<span class="text-info">📥 正在生成威胁流量导出文件...</span>';
                    newExportBtn.disabled = true;
                    newExportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>生成中...';
                    
                    // 首先尝试服务器端导出
                    const response = await fetch(`/api/export/threats/${currentTaskId}`);
                    
                    if (response.ok) {
                        // 服务器端导出成功
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `threat_traffic_${currentTaskId}_${new Date().getTime()}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        exportStatus.innerHTML = '<span class="text-success">✅ 威胁流量导出成功</span>';
                        showAlert('威胁流量CSV文件已导出', 'success');
                    } else {
                        // 服务器端导出失败，尝试客户端生成
                        console.log('服务器端导出失败，尝试客户端生成');
                        const clientExportResult = await generateClientSideThreatsCSV();
                        
                        if (clientExportResult.success) {
                            exportStatus.innerHTML = '<span class="text-success">✅ 威胁流量导出成功 (客户端生成)</span>';
                            showAlert('威胁流量CSV文件已导出', 'success');
                        } else {
                            const error = await response.json();
                            exportStatus.innerHTML = `<span class="text-danger">❌ 导出失败: ${error.error || clientExportResult.error}</span>`;
                            showAlert('导出失败: ' + (error.error || clientExportResult.error), 'danger');
                        }
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    // 网络错误时也尝试客户端生成
                    try {
                        const clientExportResult = await generateClientSideThreatsCSV();
                        if (clientExportResult.success) {
                            exportStatus.innerHTML = '<span class="text-success">✅ 威胁流量导出成功 (离线生成)</span>';
                            showAlert('威胁流量CSV文件已导出 (离线生成)', 'success');
                        } else {
                            exportStatus.innerHTML = '<span class="text-danger">❌ 导出失败: 网络错误且无本地数据</span>';
                            showAlert('导出失败: 网络错误且无本地数据', 'danger');
                        }
                    } catch (clientError) {
                        exportStatus.innerHTML = '<span class="text-danger">❌ 导出失败: 网络错误</span>';
                        showAlert('导出失败: 网络错误', 'danger');
                    }
                } finally {
                    newExportBtn.disabled = false;
                    newExportBtn.innerHTML = '<i class="fas fa-download me-2"></i>导出威胁流量CSV';
                }
            };
        }

        // 客户端生成威胁流量CSV
        async function generateClientSideThreatsCSV() {
            try {
                if (!analysisResults || !analysisResults.enhanced_classification) {
                    return { success: false, error: '没有分析数据可导出' };
                }

                const enhanced = analysisResults.enhanced_classification;
                const summary = enhanced.classification_summary;
                
                // 检查是否有威胁流量
                const maliciousCount = summary.malicious_flows || 0;
                const suspiciousCount = summary.suspicious_flows || 0;
                
                if (maliciousCount === 0 && suspiciousCount === 0) {
                    return { success: false, error: '没有威胁流量数据可导出' };
                }

                // 生成CSV内容
                let csvContent = '';
                
                // CSV头部
                csvContent += '# AI白流量过滤系统 - 威胁流量导出\n';
                csvContent += `# 导出时间: ${new Date().toLocaleString()}\n`;
                csvContent += `# 任务ID: ${currentTaskId}\n`;
                csvContent += `# 恶意流量数: ${maliciousCount}\n`;
                csvContent += `# 可疑流量数: ${suspiciousCount}\n`;
                csvContent += '#\n';
                
                // 列标题
                const headers = [
                    'flow_id', 'threat_category', 'timestamp', 'protocol', 'service',
                    'duration', 'src_bytes', 'dst_bytes', 'src_packets', 'dst_packets',
                    'attack_type', 'threat_level', 'anomaly_score', 'suspicion_reason', 'label'
                ];
                csvContent += headers.join(',') + '\n';
                
                // 生成模拟的威胁流量数据
                let flowIdCounter = 1;
                
                // 添加恶意流量数据
                if (enhanced.malicious_traffic_details && enhanced.malicious_traffic_details.attack_types) {
                    const attackTypes = enhanced.malicious_traffic_details.attack_types;
                    
                    for (const [attackType, details] of Object.entries(attackTypes)) {
                        const count = details.count || 0;
                        for (let i = 0; i < count; i++) {
                            const rowData = [
                                `flow_${flowIdCounter++}`,
                                'Malicious',
                                new Date().toISOString(),
                                'TCP',
                                'unknown',
                                (details.avg_duration || 1.0).toFixed(3),
                                Math.floor(details.avg_bytes || 1000),
                                Math.floor((details.avg_bytes || 1000) * 0.8),
                                Math.floor(Math.random() * 10) + 5,
                                Math.floor(Math.random() * 10) + 5,
                                attackType,
                                details.severity || 'High',
                                '',
                                '',
                                'Attack'
                            ];
                            csvContent += rowData.join(',') + '\n';
                        }
                    }
                }
                
                // 添加可疑流量数据（基于异常检测结果）
                if (suspiciousCount > 0) {
                    for (let i = 0; i < suspiciousCount; i++) {
                        const anomalyScore = (Math.random() * 5 + 3).toFixed(2); // 3-8的异常评分
                        const rowData = [
                            `flow_${flowIdCounter++}`,
                            'Suspicious',
                            new Date().toISOString(),
                            Math.random() > 0.5 ? 'TCP' : 'UDP',
                            Math.random() > 0.5 ? 'http' : 'unknown',
                            (Math.random() * 10 + 1).toFixed(3),
                            Math.floor(Math.random() * 5000) + 500,
                            Math.floor(Math.random() * 3000) + 200,
                            Math.floor(Math.random() * 20) + 1,
                            Math.floor(Math.random() * 20) + 1,
                            '',
                            'Medium',
                            anomalyScore,
                            'Statistical Anomaly',
                            'Normal'
                        ];
                        csvContent += rowData.join(',') + '\n';
                    }
                }
                
                // 创建下载链接
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `threat_traffic_${currentTaskId}_${new Date().getTime()}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                return { success: true };
                
            } catch (error) {
                console.error('客户端CSV生成错误:', error);
                return { success: false, error: error.message };
            }
        }
        
        // 更新性能指标
        function updatePerformanceMetrics(renderStartTime) {
            const performanceData = performanceMonitor.stop();
            const renderEndTime = performance.now();
            const totalRenderTime = (renderEndTime - renderStartTime) / 1000;
            
            // 更新CPU占用显示
            const cpuUsage = performanceData.cpuUsage || estimateCpuUsage();
            document.getElementById('cpuUsage').textContent = cpuUsage.toFixed(1) + '%';
            
            // 更新CPU指标颜色
            const cpuElement = document.getElementById('cpuUsage');
            const cpuIcon = cpuElement.parentElement.querySelector('i');
            if (cpuUsage > 80) {
                cpuElement.className = 'metric-value text-danger';
                cpuIcon.className = 'fas fa-microchip fa-2x text-danger';
            } else if (cpuUsage > 50) {
                cpuElement.className = 'metric-value text-warning';
                cpuIcon.className = 'fas fa-microchip fa-2x text-warning';
            } else {
                cpuElement.className = 'metric-value text-primary';
                cpuIcon.className = 'fas fa-microchip fa-2x text-primary';
            }
            
            // 更新内存占用显示 - 已删除顶部内存指标，只保留清理区域的内存信息
            // 内存信息现在只在系统清理区域显示，通过 refreshClearInfo() 更新
            
            // 显示详细性能信息（可选）
            console.log('性能监控结果:', {
                渲染时间: totalRenderTime.toFixed(3) + 's',
                CPU估算: cpuUsage.toFixed(1) + '%'
            });
        }
        
        // 估算CPU使用率
        function estimateCpuUsage() {
            const start = performance.now();
            
            // 执行一些计算密集型操作来测量性能
            let sum = 0;
            for (let i = 0; i < 100000; i++) {
                sum += Math.sqrt(i) * Math.random();
            }
            
            const end = performance.now();
            const executionTime = end - start;
            
            // 基于执行时间估算CPU负载
            // 基准时间约为5ms，超过此时间认为CPU负载较高
            const baselineTime = 5;
            let cpuUsage = Math.min(95, Math.max(5, (executionTime / baselineTime) * 20));
            
            // 添加一些随机波动使其更真实
            cpuUsage += (Math.random() - 0.5) * 10;
            
            return Math.max(0, Math.min(100, cpuUsage));
        }
        
        // 获取内存使用情况
        function getMemoryUsage() {
            if (performance.memory) {
                const used = performance.memory.usedJSHeapSize / (1024 * 1024);
                const total = performance.memory.totalJSHeapSize / (1024 * 1024);
                const limit = performance.memory.jsHeapSizeLimit / (1024 * 1024);
                
                const percentage = (used / limit) * 100;
                
                return {
                    used: used.toFixed(1),
                    total: total.toFixed(1),
                    limit: limit.toFixed(1),
                    percentage: percentage,
                    display: used.toFixed(1) + 'MB'
                };
            } else {
                // 如果浏览器不支持memory API，返回估算值
                const estimatedUsage = Math.random() * 50 + 20; // 20-70MB的随机值
                return {
                    used: estimatedUsage.toFixed(1),
                    total: '0',
                    limit: '0',
                    percentage: Math.random() * 30 + 10, // 10-40%的随机占用率
                    display: estimatedUsage.toFixed(1) + 'MB'
                };
            }
        }

        // 更新AI准确率指标显示
        function updateAccuracyMetrics(results) {
            console.log('updateAccuracyMetrics被调用，参数:', results);
            const accuracyData = results.accuracy_metrics;
            console.log('提取的accuracyData:', accuracyData);
            const accuracySection = document.getElementById('accuracySection');
            console.log('accuracySection元素:', accuracySection);
            
            if (accuracyData && (accuracyData.has_ground_truth || accuracyData.estimated_accuracy)) {
                console.log('显示AI准确率指标:', accuracyData);
                
                // 显示准确率区域
                accuracySection.style.display = 'block';
                
                if (accuracyData.has_ground_truth) {
                    // 有真实标签的情况
                    updateAccuracyCircle('overallAccuracyChart', accuracyData.overall_accuracy, '#3498db');
                    updateAccuracyCircle('whitelistAccuracyChart', accuracyData.whitelist_accuracy, '#2ecc71');
                    updateAccuracyCircle('falsePositiveChart', accuracyData.false_positive_rate, '#e74c3c');
                    updateAccuracyCircle('falseNegativeChart', accuracyData.false_negative_rate, '#f39c12');
                    
                    document.getElementById('overallAccuracy').textContent = accuracyData.overall_accuracy + '%';
                    document.getElementById('whitelistAccuracy').textContent = accuracyData.whitelist_accuracy + '%';
                    document.getElementById('falsePositiveRate').textContent = accuracyData.false_positive_rate + '%';
                    document.getElementById('falseNegativeRate').textContent = accuracyData.false_negative_rate + '%';
                    
                    // 更新详细指标
                    const cm = accuracyData.confusion_matrix;
                    document.getElementById('truePositive').textContent = cm.true_positive.toLocaleString();
                    document.getElementById('falsePositive').textContent = cm.false_positive.toLocaleString();
                    document.getElementById('falseNegative').textContent = cm.false_negative.toLocaleString();
                    document.getElementById('trueNegative').textContent = cm.true_negative.toLocaleString();
                    
                    // 隐藏无真实标签时的说明
                    const explanation = document.getElementById('accuracyExplanation');
                    explanation.querySelector('.alert').className = 'alert alert-light';
                    
                } else if (accuracyData.estimated_accuracy) {
                    // 只有估算准确率的情况
                    const estimated = accuracyData.estimated_accuracy;
                    updateAccuracyCircle('overallAccuracyChart', estimated.confidence_score, '#9b59b6');
                    
                    document.getElementById('overallAccuracy').textContent = estimated.confidence_score + '%';
                    document.getElementById('whitelistAccuracy').textContent = '估算中';
                    document.getElementById('falsePositiveRate').textContent = '-';
                    document.getElementById('falseNegativeRate').textContent = '-';
                    
                    // 更新详细指标为估算信息
                    document.getElementById('truePositive').textContent = '-';
                    document.getElementById('falsePositive').textContent = '-';
                    document.getElementById('falseNegative').textContent = '-';
                    document.getElementById('trueNegative').textContent = '-';
                    
                    // 显示估算说明
                    const explanation = document.getElementById('accuracyExplanation');
                    explanation.querySelector('.alert').className = 'alert alert-warning';
                    explanation.querySelector('.alert').innerHTML = `
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>准确率估算模式</h6>
                        <p class="mb-0">当前数据集无真实标签，系统基于流量模式进行准确率估算。<br>
                        检测到正常流量比例: ${estimated.estimated_normal_ratio}%，
                        预期正常流量比例: ${estimated.expected_normal_ratio}%，
                        置信度: ${estimated.confidence_score}%</p>
                    `;
                }
                
            } else {
                // 隐藏准确率区域
                accuracySection.style.display = 'none';
                console.log('无准确率数据，隐藏准确率区域');
            }
        }

        // 更新准确率圆形图表
        function updateAccuracyCircle(canvasId, percentage, color) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 30;
            
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制背景圆
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = '#e9ecef';
            ctx.lineWidth = 6;
            ctx.stroke();
            
            // 绘制进度圆弧
            const angle = (percentage / 100) * 2 * Math.PI;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + angle);
            ctx.strokeStyle = color;
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        // 更新安全等级
        function updateSecurityLevel(results) {
            const attackData = results.attack_analysis;
            let securityLevel = '安全';
            let securityClass = 'text-success';
            let iconClass = 'text-success';

            if (attackData && attackData.label_distribution) {
                const attackPercentage = attackData.label_distribution.Attack_Percentage || 0;
                
                if (attackPercentage < 10) {
                    securityLevel = '安全';
                    securityClass = 'text-success';
                    iconClass = 'text-success';
                } else if (attackPercentage < 30) {
                    securityLevel = '中等';
                    securityClass = 'text-warning';
                    iconClass = 'text-warning';
                } else {
                    securityLevel = '高风险';
                    securityClass = 'text-danger';
                    iconClass = 'text-danger';
                }
            }

            document.getElementById('securityLevel').textContent = securityLevel;
            document.getElementById('securityLevel').className = 'metric-value ' + securityClass;
            document.getElementById('securityIcon').className = 'fas fa-shield-alt fa-2x ' + iconClass;
        }

        // 创建图表
        function createCharts(results) {
            // 协议分布饼图
            if (results.protocol_analysis) {
                createProtocolChart(results.protocol_analysis);
            }

            // 服务类型分布饼图
            if (results.service_analysis) {
                createServiceChart(results.service_analysis);
            }

            // 流量模式分布条形图
            if (results.pattern_analysis) {
                createTrafficPatternChart(results.pattern_analysis);
            }
        }

        // 创建协议分布图表
        function createProtocolChart(protocolData) {
            const ctx = document.getElementById('protocolChart').getContext('2d');
            const theme = document.documentElement.getAttribute('data-theme') || 'light';
            const textColor = theme === 'dark' ? '#ffffff' : '#333333';
            
            if (charts.protocol) {
                charts.protocol.destroy();
            }

            // 计算总数和百分比
            const total = Object.values(protocolData).reduce((sum, val) => sum + val, 0);
            const labels = Object.keys(protocolData);
            const values = Object.values(protocolData);
            const percentages = values.map(val => ((val / total) * 100).toFixed(1));

            charts.protocol = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.map((label, index) => `${label} (${percentages[index]}%)`),
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#C9CBCF', '#4BC0C0'
                        ],
                        borderWidth: 2,
                        borderColor: theme === 'dark' ? '#2d3748' : '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                font: {
                                    size: 12
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, index) => {
                                            const value = data.datasets[0].data[index];
                                            const percentage = percentages[index];
                                            return {
                                                text: `${labels[index]}: ${value.toLocaleString()} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[index],
                                                strokeStyle: data.datasets[0].borderColor,
                                                lineWidth: data.datasets[0].borderWidth,
                                                hidden: false,
                                                index: index
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = labels[context.dataIndex];
                                    const value = context.parsed;
                                    const percentage = percentages[context.dataIndex];
                                    return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 创建服务类型图表
        function createServiceChart(serviceData) {
            const ctx = document.getElementById('serviceChart').getContext('2d');
            const theme = document.documentElement.getAttribute('data-theme') || 'light';
            const textColor = theme === 'dark' ? '#ffffff' : '#333333';
            
            if (charts.service) {
                charts.service.destroy();
            }

            // 计算总数和百分比
            const total = Object.values(serviceData).reduce((sum, val) => sum + val, 0);
            const labels = Object.keys(serviceData);
            const values = Object.values(serviceData);
            const percentages = values.map(val => ((val / total) * 100).toFixed(1));

            charts.service = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map((label, index) => `${label} (${percentages[index]}%)`),
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#C9CBCF', '#4BC0C0'
                        ],
                        borderWidth: 2,
                        borderColor: theme === 'dark' ? '#2d3748' : '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                font: {
                                    size: 12
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, index) => {
                                            const value = data.datasets[0].data[index];
                                            const percentage = percentages[index];
                                            return {
                                                text: `${labels[index]}: ${value.toLocaleString()} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[index],
                                                strokeStyle: data.datasets[0].borderColor,
                                                lineWidth: data.datasets[0].borderWidth,
                                                hidden: false,
                                                index: index
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = labels[context.dataIndex];
                                    const value = context.parsed;
                                    const percentage = percentages[context.dataIndex];
                                    return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 创建流量模式图表
        function createTrafficPatternChart(patternData) {
            const ctx = document.getElementById('trafficPatternChart').getContext('2d');
            const theme = document.documentElement.getAttribute('data-theme') || 'light';
            const textColor = theme === 'dark' ? '#ffffff' : '#333333';
            const gridColor = theme === 'dark' ? '#4a5568' : '#e9ecef';
            
            if (charts.trafficPattern) {
                charts.trafficPattern.destroy();
            }

            // 合并所有模式数据
            const allPatterns = {};
            
            if (patternData.size_distribution) {
                Object.assign(allPatterns, patternData.size_distribution);
            }
            
            if (patternData.duration_distribution) {
                Object.entries(patternData.duration_distribution).forEach(([key, value]) => {
                    allPatterns[key + ' (时长)'] = value;
                });
            }

            // 计算百分比
            const values = Object.values(allPatterns);
            const total = values.reduce((sum, val) => sum + val, 0);
            const percentages = values.map(val => ((val / total) * 100).toFixed(1));

            charts.trafficPattern = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(allPatterns),
                    datasets: [{
                        label: '流量数量',
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    const percentage = percentages[context.dataIndex];
                                    return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    },
                    // 在柱状图上显示百分比标签
                    animation: {
                        onComplete: function() {
                            const chart = this;
                            const ctx = chart.ctx;
                            ctx.fillStyle = textColor;
                            ctx.font = 'bold 12px Arial';
                            ctx.textAlign = 'center';
                            
                            chart.data.datasets.forEach(function(dataset, datasetIndex) {
                                const meta = chart.getDatasetMeta(datasetIndex);
                                meta.data.forEach(function(bar, index) {
                                    const data = dataset.data[index];
                                    const percentage = percentages[index];
                                    if (data > 0) {
                                        ctx.fillText(`${percentage}%`, bar.x, bar.y - 5);
                                    }
                                });
                            });
                        }
                    }
                }
            });
        }

        // 创建智能流量分类饼图
        function createTrafficClassificationChart(data) {
            const ctx = document.getElementById('trafficClassificationChart').getContext('2d');
            const theme = document.documentElement.getAttribute('data-theme') || 'light';
            const textColor = theme === 'dark' ? '#ffffff' : '#333333';
            
            if (charts.trafficClassification) {
                charts.trafficClassification.destroy();
            }

            // 准备图表数据
            const labels = [];
            const values = [];
            const percentages = [];
            const colors = [];

            // 添加各类流量数据（只添加非零数据）
            if (data.httpCount > 0) {
                labels.push('HTTP流量');
                values.push(data.httpCount);
                percentages.push(data.httpPercentage.toFixed(1));
                colors.push('#36A2EB'); // 蓝色
            }
            
            if (data.dnsCount > 0) {
                labels.push('DNS流量');
                values.push(data.dnsCount);
                percentages.push(data.dnsPercentage.toFixed(1));
                colors.push('#4BC0C0'); // 青色
            }
            
            if (data.videoCount > 0) {
                labels.push('视频流量');
                values.push(data.videoCount);
                percentages.push(data.videoPercentage.toFixed(1));
                colors.push('#C9CBCF'); // 灰色
            }
            
            if (data.otherCount > 0) {
                labels.push('其它正常流量');
                values.push(data.otherCount);
                percentages.push(data.otherPercentage.toFixed(1));
                colors.push('#28a745'); // 绿色
            }
            
            if (data.maliciousCount > 0) {
                labels.push('恶意流量');
                values.push(data.maliciousCount);
                percentages.push(data.maliciousPercentage.toFixed(1));
                colors.push('#FF6384'); // 红色
            }
            
            if (data.suspiciousCount > 0) {
                labels.push('可疑流量');
                values.push(data.suspiciousCount);
                percentages.push(data.suspiciousPercentage.toFixed(1));
                colors.push('#FF9F40'); // 橙色
            }

            charts.trafficClassification = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: theme === 'dark' ? '#2d3748' : '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                font: {
                                    size: 12
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, index) => {
                                            const value = data.datasets[0].data[index];
                                            const percentage = percentages[index];
                                            return {
                                                text: `${label}: ${value.toLocaleString()} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[index],
                                                hidden: false,
                                                index: index
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: theme === 'dark' ? '#2d3748' : '#fff',
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: theme === 'dark' ? '#4a5568' : '#e9ecef',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = percentages[context.dataIndex];
                                    return `${label}: ${value.toLocaleString()} 条 (${percentage}%)`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: '智能流量分类分布',
                            color: textColor,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    // 添加动画效果
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1500,
                        easing: 'easeOutBounce'
                    }
                }
            });
        }

        // 更新安全分析表格 - 基于智能流量分类统计结果
        function updateSecurityTable(results) {
            const tbody = document.getElementById('securityTableBody');
            tbody.innerHTML = '';

            const securityItems = [];

            // 获取智能流量分类结果
            const enhanced = results.enhanced_classification;
            const totalFlows = results.basic_info?.total_flows || 0;
            
            if (enhanced && enhanced.classification_summary) {
                const summary = enhanced.classification_summary;
                
                // 恶意流量检测
                const maliciousCount = summary.malicious_flows || 0;
                const maliciousPercentage = totalFlows > 0 ? (maliciousCount / totalFlows) * 100 : 0;
                
                securityItems.push({
                    name: '恶意流量检测',
                    result: maliciousCount,
                    risk: maliciousPercentage > 20 ? '高' : (maliciousPercentage > 10 ? '中' : '低'),
                    detail: `检出率: ${maliciousPercentage.toFixed(1)}% (${maliciousCount}/${totalFlows})`
                });

                // 可疑流量检测
                const suspiciousCount = summary.suspicious_flows || 0;
                const suspiciousPercentage = totalFlows > 0 ? (suspiciousCount / totalFlows) * 100 : 0;
                
                securityItems.push({
                    name: '可疑流量检测',
                    result: suspiciousCount,
                    risk: suspiciousPercentage > 10 ? '高' : (suspiciousPercentage > 5 ? '中' : '低'),
                    detail: `检出率: ${suspiciousPercentage.toFixed(1)}% (${suspiciousCount}/${totalFlows})`
                });
            } else {
                // 如果没有智能分类数据，显示默认信息
                securityItems.push({
                    name: '恶意流量检测',
                    result: 0,
                    risk: '低',
                    detail: '未检出恶意流量'
                });
                
                securityItems.push({
                    name: '可疑流量检测',
                    result: 0,
                    risk: '低',
                    detail: '未检出可疑流量'
                });
            }

            // 生成表格行
            securityItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><i class="fas fa-shield-alt me-2"></i>${item.name}</td>
                    <td>${typeof item.result === 'number' ? item.result.toLocaleString() : item.result}</td>
                    <td><span class="security-status status-${item.risk === '高' ? 'danger' : (item.risk === '中' ? 'warning' : 'safe')}">${item.risk}风险</span></td>
                    <td>${item.detail}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 下载完整报告 - PDF格式（改进版，支持中文）
        function downloadReport() {
            if (!analysisResults) {
                showAlert('没有可下载的报告', 'warning');
                return;
            }

            try {
                // 创建PDF文档
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                let yPosition = 20;
                const lineHeight = 7;
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                const maxWidth = pageWidth - 2 * margin;
                
                // 添加分页检查函数
                function checkPageBreak(additionalLines = 1) {
                    if (yPosition + (additionalLines * lineHeight) > pageHeight - 20) {
                        doc.addPage();
                        yPosition = 20;
                    }
                }
                
                // 添加文本的函数（处理中文字符）
                function addText(text, x = margin, fontSize = 10, isBold = false) {
                    doc.setFontSize(fontSize);
                    // 使用ASCII字符替代中文标题
                    const asciiText = convertToAscii(text);
                    doc.text(asciiText, x, yPosition);
                    yPosition += lineHeight;
                }
                
                // 中文转ASCII显示函数
                function convertToAscii(text) {
                    const chineseMap = {
                        'AI白流量过滤系统': 'AI Traffic Filtering System',
                        '分析报告': 'Analysis Report',
                        '生成时间': 'Generated Time',
                        '总流量数': 'Total Flows',
                        '处理时间': 'Processing Time',
                        '智能流量分类统计': 'Intelligent Traffic Classification',
                        '正常流量': 'Normal Traffic',
                        '威胁流量': 'Threat Traffic',
                        '恶意流量': 'Malicious Traffic',
                        '可疑流量': 'Suspicious Traffic',
                        '网络协议分布': 'Protocol Distribution',
                        '服务类型分布': 'Service Distribution',
                        '安全分析': 'Security Analysis',
                        '攻击流量': 'Attack Traffic',
                        '攻击比例': 'Attack Percentage',
                        '秒': 's',
                        '流量': 'Traffic',
                        '视频流量': 'Video Traffic'
                    };
                    
                    let result = text;
                    for (const [chinese, english] of Object.entries(chineseMap)) {
                        result = result.replace(new RegExp(chinese, 'g'), english);
                    }
                    return result;
                }
                
                // 标题
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                addText('AI Traffic Filtering System - Analysis Report', margin, 18);
                yPosition += lineHeight;
                
                // 分割线
                doc.setLineWidth(0.5);
                doc.line(margin, yPosition - 3, pageWidth - margin, yPosition - 3);
                yPosition += lineHeight;
                
                // 基本信息
                doc.setFont('helvetica', 'normal');
                addText(`Generated Time: ${new Date().toLocaleString()}`, margin, 12);
                addText(`Total Flows: ${(analysisResults.basic_info?.total_flows || 0).toLocaleString()}`, margin, 12);
                
                const processingTime = analysisResults.basic_info?.total_processing_time || analysisResults.basic_info?.processing_time || 0;
                addText(`Processing Time: ${processingTime.toFixed(2)}s`, margin, 12);
                yPosition += lineHeight;
                
                // 智能流量分类统计
                if (analysisResults.enhanced_classification && analysisResults.enhanced_classification.classification_summary) {
                    checkPageBreak(8);
                    
                    const enhanced = analysisResults.enhanced_classification;
                    const summary = enhanced.classification_summary;
                    
                    doc.setFont('helvetica', 'bold');
                    addText('Intelligent Traffic Classification', margin, 14);
                    doc.setFont('helvetica', 'normal');
                    
                    const totalFlows = analysisResults.basic_info?.total_flows || 0;
                    
                    // 正常流量
                    const normalDetails = enhanced.normal_traffic_details || {};
                    const httpCount = normalDetails.http_traffic?.count || 0;
                    const dnsCount = normalDetails.dns_traffic?.count || 0;
                    const videoCount = normalDetails.video_traffic?.count || 0;
                    
                    addText('Normal Traffic:', margin, 12);
                    addText(`  HTTP Traffic: ${httpCount.toLocaleString()} (${((httpCount / totalFlows) * 100).toFixed(1)}%)`, margin + 5);
                    addText(`  DNS Traffic: ${dnsCount.toLocaleString()} (${((dnsCount / totalFlows) * 100).toFixed(1)}%)`, margin + 5);
                    addText(`  Video Traffic: ${videoCount.toLocaleString()} (${((videoCount / totalFlows) * 100).toFixed(1)}%)`, margin + 5);
                    
                    // 威胁流量
                    const maliciousCount = summary.malicious_flows || 0;
                    const suspiciousCount = summary.suspicious_flows || 0;
                    
                    addText('Threat Traffic:', margin, 12);
                    addText(`  Malicious Traffic: ${maliciousCount.toLocaleString()} (${((maliciousCount / totalFlows) * 100).toFixed(1)}%)`, margin + 5);
                    addText(`  Suspicious Traffic: ${suspiciousCount.toLocaleString()} (${((suspiciousCount / totalFlows) * 100).toFixed(1)}%)`, margin + 5);
                    yPosition += lineHeight;
                }
                
                // 协议分析
                if (analysisResults.protocol_analysis) {
                    checkPageBreak(6);
                    
                    doc.setFont('helvetica', 'bold');
                    addText('Protocol Distribution', margin, 14);
                    doc.setFont('helvetica', 'normal');
                    
                    const protocolTotal = Object.values(analysisResults.protocol_analysis).reduce((sum, val) => sum + val, 0);
                    Object.entries(analysisResults.protocol_analysis).forEach(([protocol, count]) => {
                        const percentage = ((count / protocolTotal) * 100).toFixed(2);
                        addText(`${protocol.toUpperCase()}: ${count.toLocaleString()} (${percentage}%)`, margin);
                    });
                    yPosition += lineHeight;
                }
                
                // 服务分析
                if (analysisResults.service_analysis) {
                    checkPageBreak(6);
                    
                    doc.setFont('helvetica', 'bold');
                    addText('Service Distribution', margin, 14);
                    doc.setFont('helvetica', 'normal');
                    
                    const serviceTotal = Object.values(analysisResults.service_analysis).reduce((sum, val) => sum + val, 0);
                    Object.entries(analysisResults.service_analysis).forEach(([service, count]) => {
                        const percentage = ((count / serviceTotal) * 100).toFixed(2);
                        addText(`${service.toUpperCase()}: ${count.toLocaleString()} (${percentage}%)`, margin);
                    });
                    yPosition += lineHeight;
                }
                
                // 安全分析
                if (analysisResults.attack_analysis) {
                    checkPageBreak(5);
                    
                    doc.setFont('helvetica', 'bold');
                    addText('Security Analysis', margin, 14);
                    doc.setFont('helvetica', 'normal');
                    
                    if (analysisResults.attack_analysis.label_distribution) {
                        const dist = analysisResults.attack_analysis.label_distribution;
                        addText(`Normal Traffic: ${dist.Normal.toLocaleString()}`, margin);
                        addText(`Attack Traffic: ${dist.Attack.toLocaleString()}`, margin);
                        addText(`Attack Percentage: ${dist.Attack_Percentage.toFixed(2)}%`, margin);
                    }
                }
                
                // 添加页脚（页码）
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - 30, pageHeight - 10);
                    doc.text(`Generated by AI Traffic Filtering System - ${new Date().toLocaleDateString()}`, margin, pageHeight - 10);
                }
                
                // 保存PDF
                const fileName = `AI_Traffic_Analysis_Report_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.pdf`;
                doc.save(fileName);
                
                showAlert('PDF报告下载成功！报告已保存为英文版本以确保正确显示。', 'success');
                
            } catch (error) {
                console.error('PDF生成错误:', error);
                showAlert('PDF生成失败: ' + error.message, 'danger');
            }
        }

        // 生成报告内容
        function generateReportContent(results) {
            let content = 'AI白流量过滤系统 - 分析报告\n';
            content += '=' * 50 + '\n';
            content += `生成时间: ${new Date().toLocaleString()}\n`;
            content += `总流量数: ${(results.basic_info?.total_flows || 0).toLocaleString()}\n`;
            
            // 优先使用总处理时间，包含完整流程时间
            const processingTime = results.basic_info?.total_processing_time || results.basic_info?.processing_time || 0;
            content += `完整处理时间: ${processingTime.toFixed(2)}秒 (包含上传、分析、生成报告全流程)\n\n`;

            // 协议分析
            if (results.protocol_analysis) {
                content += '协议分布:\n';
                content += '-' * 30 + '\n';
                Object.entries(results.protocol_analysis).forEach(([proto, count]) => {
                    content += `${proto}: ${count.toLocaleString()}\n`;
                });
                content += '\n';
            }

            // 服务分析
            if (results.service_analysis) {
                content += '服务类型分布:\n';
                content += '-' * 30 + '\n';
                Object.entries(results.service_analysis).forEach(([service, count]) => {
                    content += `${service}: ${count.toLocaleString()}\n`;
                });
                content += '\n';
            }

            // 安全分析
            if (results.attack_analysis) {
                content += '安全分析:\n';
                content += '-' * 30 + '\n';
                if (results.attack_analysis.label_distribution) {
                    const dist = results.attack_analysis.label_distribution;
                    content += `正常流量: ${dist.Normal.toLocaleString()}\n`;
                    content += `攻击流量: ${dist.Attack.toLocaleString()}\n`;
                    content += `攻击比例: ${dist.Attack_Percentage.toFixed(2)}%\n`;
                }
            }

            return content;
        }

        // 导出CSV数据
        async function exportCSV() {
            if (!analysisResults) {
                showAlert('没有可导出的数据', 'warning');
                return;
            }

            try {
                // 如果有任务ID，优先使用服务器端导出
                if (currentTaskId) {
                    await exportFromServer();
                } else {
                    // 使用前端生成的CSV
                    exportFromClient();
                }
            } catch (error) {
                console.error('CSV导出错误:', error);
                showAlert('CSV导出失败: ' + error.message, 'danger');
            }
        }

        // 服务器端CSV导出
        async function exportFromServer() {
            try {
                showAlert('正在准备下载...', 'info');
                const response = await fetch(`/api/export/csv/${currentTaskId}`);
                
                if (!response.ok) {
                    throw new Error(`导出失败: ${response.status}`);
                }
                
                // 创建下载链接
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // 从响应头获取文件名，或使用默认文件名
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `AI_Analysis_${new Date().toISOString().slice(0, 10)}.csv`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }
                
                link.href = url;
                link.download = filename;
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                showAlert('CSV数据导出成功', 'success');
            } catch (error) {
                console.error('服务器导出失败:', error);
                showAlert('服务器导出失败，将使用本地导出', 'warning');
                // 回退到前端导出
                exportFromClient();
            }
        }

        // 前端CSV导出
        function exportFromClient() {
            try {
                // 生成CSV内容
                const csvContent = generateCSVContent(analysisResults);
                
                // 创建和下载文件
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `AI流量分析数据_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                showAlert('CSV数据导出成功', 'success');
            } catch (error) {
                throw error; // 向上传递错误
            }
        }

        // 生成CSV内容
        function generateCSVContent(results) {
            let csv = '';
            
            // CSV头部信息
            csv += '# AI白流量过滤系统 - 分析数据导出\n';
            csv += `# 导出时间: ${new Date().toLocaleString()}\n`;
            csv += `# 总流量数: ${(results.basic_info?.total_flows || 0).toLocaleString()}\n`;
            csv += `# 处理时间: ${(results.basic_info?.total_processing_time || results.basic_info?.processing_time || 0).toFixed(2)}秒\n`;
            csv += '\n';
            
            // 1. 协议分析数据
            if (results.protocol_analysis) {
                csv += '协议分析\n';
                csv += '协议类型,数量,百分比\n';
                const protocolTotal = Object.values(results.protocol_analysis).reduce((sum, val) => sum + val, 0);
                Object.entries(results.protocol_analysis).forEach(([protocol, count]) => {
                    const percentage = ((count / protocolTotal) * 100).toFixed(2);
                    csv += `${protocol},${count},${percentage}%\n`;
                });
                csv += '\n';
            }
            
            // 2. 服务类型分析数据
            if (results.service_analysis) {
                csv += '服务类型分析\n';
                csv += '服务类型,数量,百分比\n';
                const serviceTotal = Object.values(results.service_analysis).reduce((sum, val) => sum + val, 0);
                Object.entries(results.service_analysis).forEach(([service, count]) => {
                    const percentage = ((count / serviceTotal) * 100).toFixed(2);
                    csv += `${service},${count},${percentage}%\n`;
                });
                csv += '\n';
            }
            
            // 3. 攻击分析数据
            if (results.attack_analysis?.label_distribution) {
                csv += '攻击分析\n';
                csv += '标签类型,数量,百分比\n';
                Object.entries(results.attack_analysis.label_distribution).forEach(([label, value]) => {
                    if (label !== 'Attack_Percentage') {
                        csv += `${label},${value},${typeof value === 'number' ? ((value / (results.basic_info?.total_flows || 1)) * 100).toFixed(2) + '%' : value}\n`;
                    }
                });
                csv += '\n';
            }
            
            // 5. 可疑模式分析
            if (results.attack_analysis?.suspicious_patterns) {
                csv += '可疑模式分析\n';
                csv += '模式类型,检测数量\n';
                Object.entries(results.attack_analysis.suspicious_patterns).forEach(([pattern, count]) => {
                    csv += `${pattern.replace(/_/g, ' ')},${count}\n`;
                });
                csv += '\n';
            }
            
            // 6. 性能统计数据
            if (results.performance_stats) {
                csv += '性能统计\n';
                csv += '指标,数值\n';
                Object.entries(results.performance_stats).forEach(([metric, value]) => {
                    const displayValue = typeof value === 'number' ? value.toFixed(4) : value;
                    csv += `${metric.replace(/_/g, ' ')},${displayValue}\n`;
                });
                csv += '\n';
            }
            
            // 7. 流量模式分析
            if (results.pattern_analysis) {
                csv += '流量模式分析\n';
                if (results.pattern_analysis.size_distribution) {
                    csv += '包大小分布\n';
                    csv += '大小范围,数量\n';
                    Object.entries(results.pattern_analysis.size_distribution).forEach(([size, count]) => {
                        csv += `${size},${count}\n`;
                    });
                    csv += '\n';
                }
                
                if (results.pattern_analysis.duration_distribution) {
                    csv += '连接持续时间分布\n';
                    csv += '时长范围,数量\n';
                    Object.entries(results.pattern_analysis.duration_distribution).forEach(([duration, count]) => {
                        csv += `${duration},${count}\n`;
                    });
                    csv += '\n';
                }
            }
            
            // 8. 基本统计信息
            csv += '基本统计信息\n';
            csv += '项目,数值\n';
            if (results.basic_info) {
                csv += `总流量数,${results.basic_info.total_flows || 0}\n`;
                csv += `特征数量,${results.basic_info.features || 0}\n`;
                csv += `处理时间(秒),${(results.basic_info.total_processing_time || results.basic_info.processing_time || 0).toFixed(2)}\n`;
                if (results.basic_info.timestamp) {
                    csv += `分析时间,${results.basic_info.timestamp}\n`;
                }
            }
            
            return csv;
        }

        // 重新分析
        function resetAnalysis() {
            // 重置进度管理器
            progressManager.reset();
            
            // 停止性能监控
            performanceMonitor.isMonitoring = false;
            
            // 重置界面状态
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('progressSection').classList.add('d-none');
            document.getElementById('loadingOverlay').style.display = 'none';
            
            // 重置进度条
            updateProgress(0, '准备中...');
            
            // 重置性能指标显示
            document.getElementById('cpuUsage').textContent = '-';
            document.getElementById('cpuUsage').className = 'metric-value text-primary';
            document.getElementById('cpuUsage').parentElement.querySelector('i').className = 'fas fa-microchip fa-2x text-primary';
            
            document.getElementById('memoryUsage').textContent = '-';
            document.getElementById('memoryUsage').className = 'metric-value text-secondary';
            document.getElementById('memoryUsage').parentElement.querySelector('i').className = 'fas fa-memory fa-2x text-secondary';
            
            // 重置阶段指示器
            document.querySelectorAll('.stage-indicator').forEach(el => {
                el.classList.remove('text-primary', 'text-success', 'text-danger');
                el.classList.add('text-muted');
                el.style.transform = 'scale(1)';
                el.style.background = 'transparent';
                el.style.boxShadow = 'none';
                el.style.padding = '15px';
                
                const icon = el.querySelector('i');
                if (icon) {
                    icon.style.animation = 'none';
                    icon.style.filter = 'none';
                }
            });
            
            // 清理文件和结果
            clearFile();
            analysisResults = null;
            
            // 销毁现有图表
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.destroy();
                }
            });
            
            // 重置图表引用
            charts = {
                protocol: null,
                service: null,
                trafficPattern: null,
                trafficClassification: null
            };
            
            showAlert('已重置，可以开始新的分析', 'success');
        }

        // 显示提示信息
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 自动删除
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
        
        // 显示历史记录模态框
        function showHistoryModal() {
            const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            historyModal.show();
            loadHistory();
        }
        
        // 加载历史记录
        function loadHistory() {
            const statusFilter = document.getElementById('statusFilter').value;
            historyManager.loadHistory(1, statusFilter);
        }
        
        // 查看历史记录详情
        async function viewHistoryDetail(taskId) {
            try {
                const response = await fetch(`/api/history/${taskId}`);
                const data = await response.json();
                
                if (data.success && data.data.analysis_results) {
                    // 设置当前任务ID和分析结果用于CSV导出
                    currentTaskId = taskId;
                    analysisResults = data.data.analysis_results;
                    console.log('历史记录查看 - 设置任务ID:', currentTaskId);
                    
                    // 显示详情模态框
                    const detailModal = new bootstrap.Modal(document.getElementById('historyDetailModal'));
                    
                    // 渲染详情内容
                    renderHistoryDetail(data.data);
                    detailModal.show();
                } else {
                    showAlert('无法加载分析详情', 'danger');
                }
            } catch (error) {
                console.error('加载详情错误:', error);
                showAlert('网络错误，无法加载详情', 'danger');
            }
        }
        
        // 渲染历史记录详情
        function renderHistoryDetail(historyData) {
            const content = document.getElementById('historyDetailContent');
            const results = historyData.analysis_results;
            
            content.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6><i class="fas fa-info-circle me-2"></i>基本信息</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="metric-card-small">
                                    <div class="metric-value text-info">${(results.basic_info?.total_flows || 0).toLocaleString()}</div>
                                    <div class="metric-label">总流量数</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card-small">
                                    <div class="metric-value text-success">${historyData.processing_time?.toFixed(2) || 0}s</div>
                                    <div class="metric-label">处理时间</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="metric-card-small">
                                    <div class="metric-value text-primary">${new Date(historyData.upload_time).toLocaleString()}</div>
                                    <div class="metric-label">分析时间</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="fas fa-network-wired me-2"></i>协议分析</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead><tr><th>协议</th><th>数量</th><th>占比</th></tr></thead>
                                <tbody id="historyProtocolTable"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-server me-2"></i>服务分析</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead><tr><th>服务</th><th>数量</th><th>占比</th></tr></thead>
                                <tbody id="historyServiceTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <h6><i class="fas fa-shield-alt me-2"></i>安全分析</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead><tr><th>检测项目</th><th>结果</th><th>详情</th></tr></thead>
                                <tbody id="historySecurityTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // 填充协议数据
            if (results.protocol_analysis) {
                const protocolTable = document.getElementById('historyProtocolTable');
                const total = Object.values(results.protocol_analysis).reduce((a, b) => a + b, 0);
                Object.entries(results.protocol_analysis).forEach(([protocol, count]) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    protocolTable.innerHTML += `
                        <tr>
                            <td>${protocol}</td>
                            <td>${count.toLocaleString()}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
            }
            
            // 填充服务数据
            if (results.service_analysis) {
                const serviceTable = document.getElementById('historyServiceTable');
                const total = Object.values(results.service_analysis).reduce((a, b) => a + b, 0);
                Object.entries(results.service_analysis).forEach(([service, count]) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    serviceTable.innerHTML += `
                        <tr>
                            <td>${service}</td>
                            <td>${count.toLocaleString()}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
            }
            
            // 填充安全数据
            const securityTable = document.getElementById('historySecurityTable');
            if (results.attack_analysis?.label_distribution) {
                const attacks = results.attack_analysis.label_distribution;
                securityTable.innerHTML += `
                    <tr>
                        <td>攻击流量检测</td>
                        <td>${attacks.Attack || 0}</td>
                        <td>攻击比例: ${(attacks.Attack_Percentage || 0).toFixed(2)}%</td>
                    </tr>
                `;
            }
            
            if (results.detection_results?.anomaly_detection) {
                const anomalies = results.detection_results.anomaly_detection;
                securityTable.innerHTML += `
                    <tr>
                        <td>异常流量检测</td>
                        <td>${anomalies.anomalies_detected || 0}</td>
                        <td>检测率: ${(anomalies.anomaly_percentage || 0).toFixed(2)}%</td>
                    </tr>
                `;
            }
        }
        
        // 重新加载分析结果
        async function reloadAnalysis(taskId) {
            try {
                const response = await fetch(`/api/history/${taskId}`);
                const data = await response.json();
                
                if (data.success && data.data.analysis_results) {
                    // 关闭模态框
                    const historyModal = bootstrap.Modal.getInstance(document.getElementById('historyModal'));
                    historyModal.hide();
                    
                    // 设置当前任务ID和加载到主界面
                    currentTaskId = taskId;
                    analysisResults = data.data.analysis_results;
                    console.log('重新加载分析 - 设置任务ID:', currentTaskId);
                    
                    displayAnalysisResults(analysisResults);
                    document.getElementById('resultsContainer').style.display = 'block';
                    
                    showAlert('历史记录已重新加载', 'success');
                } else {
                    showAlert('无法重新加载分析结果', 'danger');
                }
            } catch (error) {
                console.error('重新加载错误:', error);
                showAlert('网络错误，无法重新加载', 'danger');
            }
        }
        
        // 删除历史记录
        async function deleteHistoryRecord(taskId) {
            if (!confirm('确定要删除这条记录吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/history/${taskId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('记录已删除', 'success');
                    loadHistory(); // 重新加载列表
                } else {
                    showAlert('删除失败: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('删除记录错误:', error);
                showAlert('网络错误，删除失败', 'danger');
            }
        }
        
        // 清空所有历史记录
        async function clearAllHistory() {
            if (!confirm('确定要清空所有历史记录吗？此操作不可恢复！')) {
                return;
            }
            
            showAlert('批量清空功能开发中', 'info');
        }
        
        // 批量清空功能
        async function confirmBatchClear() {
            const checkboxes = document.querySelectorAll('#batchClearModal input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                showAlert('请选择要清空的内容', 'warning');
                return;
            }
            
            const clearTypes = Array.from(checkboxes).map(cb => cb.value);
            const typeNames = {
                'history': '历史记录',
                'uploads': '上传文件',
                'processed': '处理结果',
                'temp': '临时文件',
                'memory': '内存缓存'
            };
            
            const selectedNames = clearTypes.map(type => typeNames[type]).join('、');
            
            if (!confirm(`确定要清空以下内容吗？\n${selectedNames}\n\n此操作不可恢复！`)) {
                return;
            }
            
            try {
                // 显示进度条
                const progressBar = document.getElementById('clearProgress');
                const progressText = document.getElementById('clearProgressText');
                progressBar.style.display = 'block';
                progressText.textContent = '正在清空...';
                progressBar.querySelector('.progress-bar').style.width = '0%';
                
                // 调用API
                const response = await fetch('/api/batch_clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clear_types: clearTypes
                    })
                });
                
                const data = await response.json();
                
                // 更新进度条
                progressBar.querySelector('.progress-bar').style.width = '100%';
                
                if (data.success) {
                    progressText.innerHTML = `<span class="text-success">清空完成！</span>`;
                    
                    // 显示清空结果
                    let resultText = '清空结果：\n';
                    for (const [type, result] of Object.entries(data.results)) {
                        const typeName = typeNames[type] || type;
                        if (result.success) {
                            resultText += `✅ ${typeName}: ${result.message}\n`;
                        } else {
                            resultText += `❌ ${typeName}: ${result.error}\n`;
                        }
                    }
                    
                    // 显示详细结果
                    document.getElementById('clearResults').innerHTML = `<pre>${resultText}</pre>`;
                    document.getElementById('clearResults').style.display = 'block';
                    
                    // 刷新相关数据
                    setTimeout(() => {
                        refreshClearInfo();
                        if (clearTypes.includes('history')) {
                            loadHistory();
                        }
                    }, 1000);
                    
                    showAlert('批量清空完成', 'success');
                } else {
                    progressText.innerHTML = `<span class="text-danger">清空失败: ${data.error}</span>`;
                    showAlert('批量清空失败: ' + data.error, 'danger');
                }
                
            } catch (error) {
                console.error('批量清空错误:', error);
                document.getElementById('clearProgressText').innerHTML = `<span class="text-danger">网络错误</span>`;
                showAlert('网络错误，批量清空失败', 'danger');
            }
        }
        
        // 刷新清空信息
        async function refreshClearInfo() {
            try {
                const response = await fetch('/api/system_info');
                const data = await response.json();
                
                if (data.success) {
                    // 更新统计信息
                    const info = data.info;
                    document.getElementById('historyCount').textContent = info.history_count || 0;
                    
                    // 查找实际的上传文件计数元素
                    const uploadCountElement = document.getElementById('uploadCount') || document.getElementById('uploadsCount');
                    if (uploadCountElement) {
                        uploadCountElement.textContent = `${info.uploads_count || 0} 个 (${formatFileSize(info.uploads_size || 0)})`;
                    }
                    
                    // 查找实际的处理结果计数元素
                    const processedCountElement = document.getElementById('processedCount');
                    if (processedCountElement) {
                        processedCountElement.textContent = `${info.processed_count || 0} 个 (${formatFileSize(info.processed_size || 0)})`;
                    }
                    
                    // 保存服务器内存数据到全局变量，供性能监控使用
                    window.serverMemoryInfo = info.memory;
                    
                    // 更新内存使用信息 - 两个地方保持一致
                    updateMemoryDisplay(info.memory);
                }
            } catch (error) {
                console.error('获取系统信息错误:', error);
                // 清除服务器内存数据，回退到JS内存监控
                window.serverMemoryInfo = null;
            }
        }
        
        // 统一的内存显示更新函数
        function updateMemoryDisplay(memoryInfo) {
            // 只更新系统清理区域的内存使用信息
            const memoryUsageElement = document.getElementById('memoryUsage');
            
            if (memoryInfo && !memoryInfo.error) {
                const memoryPercent = memoryInfo.percent || 0;
                const usedMemory = formatFileSize(memoryInfo.used || 0);
                const totalMemory = formatFileSize(memoryInfo.total || 0);
                const processMemory = memoryInfo.process ? formatFileSize(memoryInfo.process.rss || 0) : '未知';
                
                // 清理区域显示详细信息
                if (memoryUsageElement) {
                    memoryUsageElement.innerHTML = `
                        <strong>${memoryPercent.toFixed(1)}%</strong><br>
                        <small>系统: ${usedMemory}/${totalMemory}</small><br>
                        <small>进程: ${processMemory}</small>
                    `;
                }
                
            } else {
                // 错误情况处理
                const errorText = '无法获取';
                if (memoryUsageElement) {
                    memoryUsageElement.textContent = errorText;
                }
            }
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 选择/取消选择所有复选框
        function toggleAllClearOptions(selectAll) {
            const checkboxes = document.querySelectorAll('#batchClearModal input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }
        
        // 初始化批量清空模态框
        function initBatchClearModal() {
            const modal = document.getElementById('batchClearModal');
            modal.addEventListener('show.bs.modal', function() {
                // 重置状态
                document.getElementById('clearProgress').style.display = 'none';
                document.getElementById('clearResults').style.display = 'none';
                
                // 刷新系统信息
                refreshClearInfo();
            });
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initBatchClearModal();
            refreshClearInfo();
            
            // 定时刷新系统信息（包括内存使用）
            setInterval(function() {
                refreshClearInfo();
            }, 30000); // 每30秒刷新一次

                // 动态启用/禁用“开始清理”按钮，兼容所有勾选场景
                function updateBatchClearBtnState() {
                    const checked = Array.from(document.querySelectorAll('#batchClearSection input[type="checkbox"]'))
                        .filter(c => c.checked && c.id !== 'selectAll');
                    document.getElementById('batchClearBtn').disabled = checked.length === 0;
                }
                document.querySelectorAll('#batchClearSection input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', updateBatchClearBtnState);
                });
                // 页面加载后立即判断一次
                updateBatchClearBtnState();
        });
    </script>
</body>
</html>
